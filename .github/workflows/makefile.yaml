# 工作流程名称
name: KPM-Build-Anywhere 自动化构建部署
# 触发条件：指定分支的 push/PR 事件触发
on:
  push:
    branches: [ main, develop ] # 仅监听主分支、开发分支推送
  pull_request:
    branches: [ main, develop ] # 仅监听目标为主/开发分支的 PR

# 任务集合
jobs:
  # 核心任务：构建+测试（全分支通用）
  build-and-test:
    # 运行环境：多系统兼容（轻量化项目可只保留 ubuntu-latest）
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        # 若项目有固定技术栈（如 Node.js），可添加版本矩阵，示例：
        # node-version: [ 16.x, 18.x ]

    steps:
      # 步骤1：拉取仓库代码
      - name: 拉取仓库源码
        uses: actions/checkout@v4

      # 步骤2：配置项目运行环境（按需修改，示例为 Node.js 场景，非 Node 项目可删除/替换）
      - name: 配置 Node.js 环境
        uses: actions/setup-node@v4
        with:
          node-version: 18.x # 替换为项目实际依赖的版本
          cache: 'npm' # 缓存 npm 依赖，加速构建（yarn 项目改为 cache: 'yarn'）

      # 步骤3：安装项目依赖（按需修改命令，适配项目包管理器）
      - name: 安装依赖
        run: |
          npm install # npm 项目用此命令；yarn 用 yarn install；其他技术栈改对应命令（如 pip install）

      # 步骤4：自动化构建（核心命令，必须替换为项目实际构建命令）
      - name: 项目构建
        run: npm run build # 示例：Vue/React 项目常用；非前端项目改对应命令（如 go build、mvn package）

      # 步骤5：自动化测试（按需保留，无测试流程可删除）
      - name: 自动化测试
        run: npm run test # 替换为项目实际测试命令（如 pytest、go test）

      # 步骤6：main 分支专属：打包构建产物（仅主分支执行，便于发布下载）
      - name: 打包主分支产物（仅 main 分支）
        if: github.ref == 'refs/heads/main' # 分支判断条件：仅 main 分支触发
        run: |
          # 打包命令（示例：压缩 dist 目录为 build-output.zip，按需修改目录和格式）
          zip -r build-output-${{ github.sha }}.zip dist/ # ubuntu/macos 用；windows 可换 7z 命令或删除系统兼容

      # 步骤7：main 分支专属：上传产物为 GitHub Artifact（可直接下载发布）
      - name: 上传主分支构建产物
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: kpm-build-output-${{ github.sha }} # 产物名称（带 commit 哈希，便于追溯）
          path: build-output-${{ github.sha }}.zip # 产物路径，与步骤6打包路径一致
          retention-days: 30 # 产物保留30天，按需调整

  # 可选扩展任务：main 分支自动发布（若需推送到镜像仓库/云服务，可新增此任务）
  deploy-to-release:
    # 依赖 build-and-test 任务，构建测试通过后才执行发布
    needs: build-and-test
    runs-on: ubuntu-latest
    # 仅 main 分支 push 事件触发（PR 不触发发布）
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      # 步骤1：拉取代码（发布需源码/产物，按需选择）
      - name: 拉取仓库源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 拉取全提交记录，便于打标签

      # 步骤2：下载之前打包的构建产物（若发布需产物）
      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: kpm-build-output-${{ github.sha }}
          path: ./output

      # 步骤3：自动打版本标签（按语义化版本，可手动指定或自动递增，示例自动递增补丁版）
      - name: 生成版本标签
        id: tag-version
        run: |
          # 获取最新标签，无标签则从 v1.0.0 开始
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          # 提取版本号并递增补丁版（如 v1.0.0 → v1.0.1）
          new_tag=$(echo $latest_tag | awk -F. '{print $1"."$2"."$3+1}')
          echo "new_tag=$new_tag" >> $GITHUB_ENV

      # 步骤4：推送版本标签到远程仓库
      - name: 推送版本标签
        run: |
          git tag ${{ env.new_tag }}
          git push origin ${{ env.new_tag }}

      # 步骤5：创建 GitHub Release（自动生成发布记录，附带产物）
      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.new_tag }} # 版本标签
          release_name: 版本发布 ${{ env.new_tag }} # 发布标题
          body: |
            ## 版本更新内容
            - 自动构建产物发布
            - 提交哈希：${{ github.sha }}
            - 发布时间：${{ github.event.head_commit.timestamp }}
          files: ./output/build-output-${{ github.sha }}.zip # 附带构建产物，支持下载
          draft: false # 非草稿发布
          prerelease: false # 非预发布
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub 内置密钥，无需手动配置
