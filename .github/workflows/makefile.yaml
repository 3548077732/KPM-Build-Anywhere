name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing
          sudo apt-get install -y --no-install-recommends build-essential wget unzip findutils md5sum
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
        continue-on-error: false

      # æ ¸å¿ƒç»ˆæä¿®å¤ï¼šå…¨å±€æƒé™+å¼ºåˆ¶è§£å‹+MD5æ ¡éªŒ+å…¨æµç¨‹å¯è§†åŒ–
      - name: Download & Extract Android NDK (r25c, Full Permission)
        run: |
          # 1. å›ºå®šé…ç½®ï¼ˆé¿å…å˜é‡åå·®ï¼Œå…¨ç¨‹ç¡¬ç¼–ç å…³é”®è·¯å¾„ï¼Œé›¶æ­§ä¹‰ï¼‰
          NDK_VERSION="r25c"
          NDK_MD5="a9a4f843773848921983e148a937f08c"  # NDK r25c Linuxç‰ˆå®˜æ–¹MD5ï¼Œç¡®ä¿å‹ç¼©åŒ…å®Œæ•´
          NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          NDK_ZIP="/home/runner/ndk.zip"  # å›ºå®šå‹ç¼©åŒ…è·¯å¾„
          NDK_DIR="/home/runner/android-ndk"  # å›ºå®šè§£å‹ç›®å½•ï¼Œç®€å•æ— æ­§ä¹‰
          
          # 2. å¼ºåˆ¶åˆ›å»ºè§£å‹ç›®å½•+èµ‹äºˆå…¨å±€æœ€é«˜æƒé™ï¼ˆ777=è¯»å†™æ‰§è¡Œå…¨å¼€æ”¾ï¼Œæ‰€æœ‰ç”¨æˆ·å¯æ“ä½œï¼‰
          echo "ğŸ”‘ å¼ºåˆ¶åˆ›å»ºè§£å‹ç›®å½•å¹¶èµ‹å…¨å±€æƒé™..."
          sudo rm -rf ${NDK_DIR}  # å…ˆåˆ é™¤æ—§ç›®å½•ï¼Œé¿å…æ®‹ç•™å¹²æ‰°
          sudo mkdir -p ${NDK_DIR}  # å¼ºåˆ¶åˆ›å»ºç›®å½•ï¼ˆ-pç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨ï¼‰
          sudo chmod -R 777 ${NDK_DIR}  # é€’å½’èµ‹å…¨å±€æƒé™ï¼Œå½»åº•æ¶ˆé™¤æƒé™éšœç¢
          sudo chown -R runner:runner ${NDK_DIR}  # å½’å±runnerç”¨æˆ·ï¼ŒåŒé‡ä¿é™©
          ls -ld ${NDK_DIR}  # æ‰“å°ç›®å½•æƒé™ï¼Œç¡®è®¤é…ç½®ç”Ÿæ•ˆ
          
          # 3. ä¸‹è½½NDK+å¼ºåˆ¶æ ¡éªŒå®Œæ•´æ€§ï¼ˆMD5ç²¾å‡†éªŒè¯ï¼Œæœç»å‹ç¼©åŒ…æŸåï¼‰
          echo "ğŸ“¥ ä¸‹è½½NDK ${NDK_VERSION}ï¼ˆé˜¿é‡Œäº‘é•œåƒï¼Œç¨³å®šé«˜é€Ÿï¼‰..."
          sudo wget -O ${NDK_ZIP} \
            --timeout=600 --tries=10 --show-progress --progress=bar:force \
            --no-check-certificate  # è§„é¿è¯ä¹¦æ ¡éªŒé—®é¢˜ï¼Œé˜²æ­¢ä¸‹è½½ä¸­æ–­
          # MD5æ ¡éªŒï¼ˆæ ¸å¿ƒï¼šå‹ç¼©åŒ…æŸåæ˜¯è§£å‹å¤±è´¥æ ¸å¿ƒéšæ€§åŸå› ï¼‰
          echo "âœ… æ ¡éªŒå‹ç¼©åŒ…å®Œæ•´æ€§ï¼ˆMD5ï¼‰..."
          CALC_MD5=$(md5sum ${NDK_ZIP} | awk '{print $1}')
          if [ "${CALC_MD5}" != "${NDK_MD5}" ]; then
            echo "Error: NDKå‹ç¼©åŒ…æŸåï¼é¢„æœŸMD5: ${NDK_MD5}ï¼Œå®é™…MD5: ${CALC_MD5}"
            sudo rm -f ${NDK_ZIP}
            exit 1
          fi
          echo "âœ… å‹ç¼©åŒ…å®Œæ•´ï¼ŒMD5åŒ¹é…"
          
          # 4. å¼ºåˆ¶è§£å‹+å…¨ç¨‹æ—¥å¿—+äºŒæ¬¡èµ‹æƒï¼ˆç¡®ä¿æ–‡ä»¶å…¨é‡è§£å‹ï¼‰
          echo "ğŸ“¦ å¼ºåˆ¶è§£å‹NDKåˆ° ${NDK_DIR}ï¼ˆå…¨ç¨‹sudoï¼Œæ— æƒé™é™åˆ¶ï¼‰..."
          # å¼ºåˆ¶è§£å‹ï¼ˆ-oè¦†ç›–æ—§æ–‡ä»¶ï¼Œ-uæ›´æ–°ï¼Œ-vè¯¦ç»†æ—¥å¿—ï¼Œæ— é™é»˜æ¨¡å¼ï¼‰
          sudo unzip -o -u -v ${NDK_ZIP} -d ${NDK_DIR} || {
            echo "Error: NDKè§£å‹å¤±è´¥ï¼æŸ¥çœ‹å‹ç¼©åŒ…å†…å®¹..."
            sudo unzip -l ${NDK_ZIP}  # æ‰“å°å‹ç¼©åŒ…å†…æ–‡ä»¶ï¼Œç¡®è®¤æ˜¯å¦æœ‰æ ¸å¿ƒå†…å®¹
            sudo rm -f ${NDK_ZIP}
            exit 1
          }
          # è§£å‹åäºŒæ¬¡èµ‹å…¨å±€æƒé™ï¼Œç¡®ä¿æ‰€æœ‰å­æ–‡ä»¶å¯æ“ä½œ
          sudo chmod -R 777 ${NDK_DIR}
          sudo chown -R runner:runner ${NDK_DIR}
          
          # 5. å¼ºåˆ¶ç¡®è®¤è§£å‹æˆåŠŸï¼ˆå¯è§†åŒ–ç›®å½•ç»“æ„ï¼Œæ— æ–‡ä»¶ç¼ºå¤±ï¼‰
          echo "âœ… è§£å‹å®Œæˆï¼Œæ‰“å°ç›®å½•æ ¸å¿ƒç»“æ„ï¼ˆç¡®è®¤toolchainså­˜åœ¨ï¼‰..."
          ls -la ${NDK_DIR}/  # æ‰“å°è§£å‹æ ¹ç›®å½•
          ls -la ${NDK_DIR}/toolchains/  # æ‰“å°æ ¸å¿ƒå·¥å…·é“¾ç›®å½•ï¼Œç¡®è®¤å­˜åœ¨
          # è‹¥toolchainsç›®å½•ä¸å­˜åœ¨ï¼Œç›´æ¥æŠ¥é”™ï¼ˆæ ¸å¿ƒç›®å½•ç¼ºå¤±ï¼Œæ— éœ€ç»§ç»­ï¼‰
          if [ ! -d "${NDK_DIR}/toolchains/llvm/prebuilt" ]; then
            echo "Error: NDKæ ¸å¿ƒå·¥å…·é“¾ç›®å½•ç¼ºå¤±ï¼"
            ls -la ${NDK_DIR}/toolchains/llvm/
            exit 1
          fi
          
          # 6. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼Œå·¥å…·é“¾è·¯å¾„æ— åå·®ï¼‰
          NDK_TOOLCHAIN_BIN=$(find ${NDK_DIR} -name "aarch64-linux-android-clang" -type f | xargs dirname | head -n1)
          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_HOME=${NDK_DIR}" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH
          echo "âœ… NDKé…ç½®å®Œæˆï¼Œå·¥å…·é“¾è·¯å¾„ï¼š${NDK_TOOLCHAIN_BIN}"
        continue-on-error: false

      # ç¼–è¯‘å™¨æ ¡éªŒï¼ˆåŒé‡ç¡®è®¤ï¼Œç¡®ä¿å¯ç”¨ï¼‰
      - name: Verify AArch64 Compiler (Full Check)
        run: |
          echo "=== 1. ç¡®è®¤NDK_HOMEç¯å¢ƒå˜é‡ ==="
          if [ -z "${NDK_HOME}" ]; then
            echo "Error: NDK_HOMEç¼ºå¤±ï¼"
            exit 1
          fi
          echo "NDK_HOME: ${NDK_HOME}"
          
          echo "=== 2. å…¨å±€æœç´¢ç¼–è¯‘å™¨ï¼ˆç¡®ä¿æ–‡ä»¶å­˜åœ¨ï¼‰ ==="
          COMPILER=$(find ${NDK_HOME} -name "aarch64-linux-android-clang" -type f | head -n1)
          if [ -z "${COMPILER}" ]; then
            echo "Error: ç¼–è¯‘å™¨ç¼ºå¤±ï¼æ‰“å°æ‰€æœ‰clangå·¥å…·..."
            find ${NDK_HOME} -name "*clang*" -type f
            exit 1
          fi
          echo "æ‰¾åˆ°ç¼–è¯‘å™¨ï¼š${COMPILER}"
          
          echo "=== 3. å¼ºåˆ¶èµ‹æ‰§è¡Œæƒé™ï¼ˆæœ€åä¿é™©ï¼‰ ==="
          sudo chmod 777 ${COMPILER}
          if [ ! -x "${COMPILER}" ]; then
            echo "Error: ç¼–è¯‘å™¨æ— æ‰§è¡Œæƒé™ï¼"
            exit 1
          fi
          
          echo "=== 4. ç¼–è¯‘å™¨ç‰ˆæœ¬éªŒè¯ï¼ˆæœ€ç»ˆç¡®è®¤ï¼‰ ==="
          ${COMPILER} --version || {
            echo "Error: ç¼–è¯‘å™¨æ‰§è¡Œå¤±è´¥ï¼æ–‡ä»¶ä¿¡æ¯ï¼š"
            file ${COMPILER}
            exit 1
          }
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯100%é€šè¿‡"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
        continue-on-error: false

      # ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼ˆå…¨ç¨‹æ— æƒé™éšœç¢ï¼‰
      - name: Compile AArch64 Kernel Module
        run: |
          echo "=== ç¡®è®¤Makefileå­˜åœ¨ ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }

          echo "=== å¼€å§‹äº¤å‰ç¼–è¯‘ï¼ˆå…¨å±€æƒé™ï¼Œæ— é˜»ç¢ï¼‰ ==="
          make -j$(nproc) V=1 \
            CC="${COMPILER}" \
            CXX=$(find ${NDK_HOME} -name "aarch64-linux-android-clang++" -type f | head -n1) \
            TARGET_API=31
        continue-on-error: false

      # éå¿…éœ€æ­¥éª¤ï¼Œå®¹é”™å¤„ç†
      - name: Run tests (if supported)
        run: make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: make distcheck
        continue-on-error: true
