name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉全代码，避免文件缺失
          show-progress: true
        continue-on-error: false

      - name: Install build dependencies
        run: |
          sudo sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list
          sudo sed -i s@/security.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list
          sudo apt-get update -y --fix-missing --allow-releaseinfo-change
          sudo apt-get install -f -y
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            autoconf \
            automake \
            libtool \
            texinfo \
            pkg-config
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          # 校验依赖工具完整性
          autoconf --version || exit 1
          automake --version || exit 1
        continue-on-error: false

      # 关键新增：生成configure脚本（解决"找不到configure"核心问题）
      - name: Generate configure script
        run: |
          # autoreconf强制生成configure，适配无预编译脚本的项目
          autoreconf -i -f
          # 验证脚本是否生成成功
          if [ ! -f ./configure ]; then
            echo "Error: configure script not generated!"
            ls -la  # 打印根目录文件，方便排查
            exit 1
          fi
        continue-on-error: false

      - name: Generate Makefile (configure)
        run: ./configure
        continue-on-error: false

      - name: Compile project
        run: |
          echo "=== Start compiling ==="
          make -j$(nproc) V=1
        continue-on-error: false

      - name: Run unit tests (make check)
        run: make check
        continue-on-error: false

      - name: Verify release package (make distcheck)
        run: make distcheck
        continue-on-error: false
            autoconf \
            automake \
            libtool \
            texinfo \
            pkg-config
          # 清理缓存释放空间
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          # 校验工具可用性
          gcc --version || exit 1
          make --version || exit 1
          autoconf --version || exit 1
        continue-on-error: false

      # 步骤3：生成Makefile（50-52行）
      - name: Generate Makefile (configure)
        run: ./configure
        continue-on-error: false

      # 步骤4：编译项目（55-61行，重点修复此处！）
      - name: Compile project
        run: |
          echo "=== 多线程编译 ==="
          make -j$(nproc) V=1  # 详细日志便于排错
        continue-on-error: false  # 第61行：与run同级缩进，语法绝对合规

      # 步骤5：执行测试（64-66行）
      - name: Run unit tests (make check)
        run: make check
        continue-on-error: false

      # 步骤6：校验发布包（69-71行）
      - name: Verify release package (make distcheck)
        run: make distcheck
        continue-on-error: false
