name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build_desc:
        description: 'æ„å»ºæè¿°ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘å†…æ ¸æ¨¡å—æ„å»º'
      build_env:
        description: 'æ„å»ºç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - test
      # æ–°å¢ï¼šå®¹é”™å¼€å…³ï¼Œè‹¥ç¡®è®¤æ— éœ€kpmodule.hï¼Œå¯æ‰‹åŠ¨é€‰æ‹©è·³è¿‡æ ¡éªŒï¼ˆé»˜è®¤ä¸è·³è¿‡ï¼Œä¿è¯ä¸¥è°¨ï¼‰
      skip_kpmodule_check:
        description: 'æ˜¯å¦è·³è¿‡kpmodule.hå¤´æ–‡ä»¶æ ¡éªŒï¼ˆä»…å½“ç¡®è®¤æ— éœ€è¯¥æ–‡ä»¶æ—¶é€‰æ‹©"æ˜¯"ï¼‰'
        required: true
        default: 'æ˜¯'
        type: choice
        options:
          - æ˜¯
          - å¦

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          set -euo pipefail; set -x
          sudo sed -i 's@http://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@http://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing --allow-releaseinfo-change
          sudo apt-get install -y --no-install-recommends build-essential wget curl unzip findutils git
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          md5sum --version || echo "md5sumå·²å†…ç½®ï¼Œæ— éœ€å®‰è£…"
        continue-on-error: false

      - name: Download Android Kernel Source (aarch64, API 31)
        run: |
          set -euo pipefail; set -x
          KERNEL_VERSION="android12-5.10"
          KERNEL_DIR="/home/runner/android-kernel-source"
          KERNEL_REPO="https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/kernel/common.git"

          sudo rm -rf ${KERNEL_DIR}
          sudo mkdir -p ${KERNEL_DIR}
          sudo chmod -R 777 ${KERNEL_DIR}
          sudo chown -R runner:runner ${KERNEL_DIR}

          git clone --depth 1 --branch ${KERNEL_VERSION} ${KERNEL_REPO} ${KERNEL_DIR} || {
            echo "âŒ æ¸…åé•œåƒå…‹éš†å¤±è´¥ï¼Œåˆ‡æ¢å®˜æ–¹é•œåƒé‡è¯•..."
            git clone --depth 1 --branch ${KERNEL_VERSION} https://android.googlesource.com/kernel/common.git ${KERNEL_DIR} || {
              echo "âŒ å†…æ ¸æºç ä¸‹è½½å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
              exit 1
            }
          }

          # å†…æ ¸å¤´æ–‡ä»¶å¤šè·¯å¾„æ ¡éªŒï¼Œæå‰ç¡®ä¿æ ¸å¿ƒç›®å½•å­˜åœ¨
          KERNEL_INCLUDE_DIRS=(
            "${KERNEL_DIR}/include"
            "${KERNEL_DIR}/include/linux"
            "${KERNEL_DIR}/include/uapi"
            "${KERNEL_DIR}/arch/arm64/include"
            "${KERNEL_DIR}/arch/arm64/include/asm"
            "${KERNEL_DIR}/arch/arm64/include/uapi"
            "${KERNEL_DIR}/include/asm-generic"
          )
          for DIR in "${KERNEL_INCLUDE_DIRS[@]}"; do
            if [ ! -d ${DIR} ]; then
              echo "âŒ å†…æ ¸å¤´æ–‡ä»¶ç›®å½• ${DIR} ç¼ºå¤±ï¼"
              exit 1
            fi
          done
          echo "âœ… å†…æ ¸æºç ä¸‹è½½å®Œæˆï¼Œæ‰€æœ‰æ ¸å¿ƒå¤´æ–‡ä»¶ç›®å½•å‡å­˜åœ¨"
          echo "KERNEL_DIR=${KERNEL_DIR}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Download & Extract Android NDK (r25c, Super Fault-Tolerant)
        run: |
          set -euo pipefail; set -x
          NDK_VERSION="r25c"
          CORRECT_NDK_MD5="7845ab5be16149828ebac818a087d4ab"
          MIN_NDK_SIZE=$((450 * 1024 * 1024))
          ALIYUN_NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          GOOGLE_NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          HUAWEI_NDK_URL="https://mirrors.huaweicloud.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          NDK_ZIP="/home/runner/ndk.zip"
          NDK_UNZIP_DIR="/home/runner/android-ndk-unzip"
          REAL_NDK_DIR=""

          echo "ğŸ”§ æ¸…ç†æ—§æ–‡ä»¶..."
          sudo rm -rf ${NDK_ZIP} ${NDK_UNZIP_DIR}
          sudo mkdir -p ${NDK_UNZIP_DIR}
          sudo chmod -R 777 ${NDK_UNZIP_DIR}
          sudo chown -R runner:runner ${NDK_UNZIP_DIR}
          ls -ld ${NDK_UNZIP_DIR}

          download_ndk() {
            local url=$1
            echo -e "\nğŸ“¥ å°è¯•ä»æºä¸‹è½½ï¼š${url}"
            sudo rm -f ${NDK_ZIP}
            echo "ğŸ”¹ ä¼˜å…ˆä½¿ç”¨wgetä¸‹è½½..."
            sudo wget --no-cache --no-cookies --timeout=1200 \
              --tries=10 --retry-connrefused --waitretry=30 --progress=bar:force \
              --no-check-certificate -O ${NDK_ZIP} ${url} -S 2>&1 | grep "HTTP/" || {
                echo "ğŸ”¹ wgetä¸‹è½½å¤±è´¥ï¼Œåˆ‡æ¢curlé‡è¯•..."
                sudo curl -fSL --connect-timeout 1200 --retry 10 --retry-delay 30 \
                  --retry-max-time 3600 --insecure -o ${NDK_ZIP} ${url} -w "HTTPçŠ¶æ€ç ï¼š%{http_code}\n" || {
                  echo "âŒ è¯¥æºåŒå·¥å…·ä¸‹è½½å‡å¤±è´¥"
                  return 1
                }
              }
            if [ ! -f ${NDK_ZIP} ] || [ ! -s ${NDK_ZIP} ]; then
              echo "âŒ ä¸‹è½½æ–‡ä»¶ä¸å­˜åœ¨/ä¸ºç©º"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            local zip_size=$(du -b ${NDK_ZIP} | awk '{print $1}')
            echo "ğŸ“ å‹ç¼©åŒ…ä½“ç§¯ï¼š${zip_size}å­—èŠ‚ï¼ˆçº¦$(echo "scale=2; ${zip_size}/1024/1024" | bc)MBï¼‰"
            if [ ${zip_size} -lt ${MIN_NDK_SIZE} ]; then
              echo "âŒ ä½“ç§¯è¿‡å°ï¼Œåˆ¤å®šæŸå"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            local calc_md5=$(md5sum ${NDK_ZIP} | awk '{print $1}')
            if [ "${calc_md5}" != "${CORRECT_NDK_MD5}" ]; then
              echo "âŒ MD5ä¸åŒ¹é…ï¼ˆé¢„æœŸï¼š${CORRECT_NDK_MD5}ï¼Œå®é™…ï¼š${calc_md5}ï¼‰"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            echo "ğŸ” æ ¡éªŒå‹ç¼©åŒ…å†…ç»“æ„ï¼ˆå‰20ä¸ªæ–‡ä»¶ï¼‰..."
            local zip_file_count=$(sudo unzip -l ${NDK_ZIP} | wc -l)
            if [ ${zip_file_count} -lt 10 ]; then
              echo "âŒ å‹ç¼©åŒ…å†…æ— æœ‰æ•ˆå†…å®¹ï¼Œåˆ¤å®šæŸå"
              sudo unzip -l ${NDK_ZIP}
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            echo "âœ… è¯¥æºä¸‹è½½æˆåŠŸï¼Œå‹ç¼©åŒ…å®Œæ•´ä¸”å†…å«æœ‰æ•ˆå†…å®¹"
            return 0
          }

          if download_ndk ${ALIYUN_NDK_URL}; then
            echo -e "\nğŸ‰ ä¼˜å…ˆæºï¼ˆé˜¿é‡Œäº‘ï¼‰ä¸‹è½½æˆåŠŸ"
          elif download_ndk ${HUAWEI_NDK_URL}; then
            echo -e "\nğŸ‰ å¤‡ç”¨æº1ï¼ˆåä¸ºé•œåƒï¼‰ä¸‹è½½æˆåŠŸ"
          elif download_ndk ${GOOGLE_NDK_URL}; then
            echo -e "\nğŸ‰ å¤‡ç”¨æº2ï¼ˆè°·æ­Œå®˜æ–¹ï¼‰ä¸‹è½½æˆåŠŸ"
          else
            echo -e "\nâŒ 3æºåŒå·¥å…·ä¸‹è½½å‡å¤±è´¥"
            exit 1
          fi

          echo -e "\nğŸ“¦ è§£å‹NDKåˆ° ${NDK_UNZIP_DIR}..."
          sudo unzip -o -q ${NDK_ZIP} -d ${NDK_UNZIP_DIR} || {
            echo "âŒ è§£å‹å¤±è´¥ï¼ŒæŸ¥çœ‹å‹ç¼©åŒ…å†…å®¹..."
            sudo unzip -l ${NDK_ZIP} | head -30
            sudo rm -f ${NDK_ZIP}
            exit 1
          }
          echo -e "\nğŸ“‚ è§£å‹åç›®æ ‡ç›®å½•å†…å®¹ï¼ˆå«å­ç›®å½•ï¼‰ï¼š"
          ls -la ${NDK_UNZIP_DIR}/
          unzip_file_count=$(find ${NDK_UNZIP_DIR} -type f | wc -l)
          if [ ${unzip_file_count} -eq 0 ]; then
            echo "âŒ è§£å‹åç›®å½•ä¸ºç©ºï¼Œæ— ä»»ä½•æœ‰æ•ˆæ–‡ä»¶ï¼Œåˆ¤å®šè§£å‹å¤±è´¥"
            echo "ğŸ” å‹ç¼©åŒ…å†…å®Œæ•´æ–‡ä»¶åˆ—è¡¨ï¼ˆå‰50ä¸ªï¼‰ï¼š"
            sudo unzip -l ${NDK_ZIP} | head -50
            sudo rm -f ${NDK_ZIP}
            exit 1
          fi
          echo "âœ… è§£å‹æˆåŠŸï¼Œå…±è§£å‹å‡º ${unzip_file_count} ä¸ªæ–‡ä»¶"

          echo -e "\nğŸ” åŠ¨æ€æŸ¥æ‰¾çœŸå®NDKæ ¹ç›®å½•..."
          REAL_NDK_DIR=$(find ${NDK_UNZIP_DIR} -maxdepth 2 -type d -exec test -d "{}/toolchains/llvm/prebuilt" \; -print | head -n1)
          if [ -z "${REAL_NDK_DIR}" ] || [ ! -d "${REAL_NDK_DIR}" ]; then
            REAL_NDK_DIR=$(find ${NDK_UNZIP_DIR} -type d -exec test -d "{}/toolchains/llvm/prebuilt" \; -print | head -n1)
          fi
          if [ -z "${REAL_NDK_DIR}" ] || [ ! -d "${REAL_NDK_DIR}" ]; then
            REAL_NDK_DIR=$(ls -d ${NDK_UNZIP_DIR}/*/ 2>/dev/null | head -n1)
          fi
          if [ -z "${REAL_NDK_DIR}" ] || [ ! -d "${REAL_NDK_DIR}" ]; then
            echo "âŒ æœªæ‰¾åˆ°çœŸå®NDKæ ¹ç›®å½•ï¼Œæ‰“å°å…¨é‡è§£å‹ç›®å½•ç»“æ„ï¼š"
            find ${NDK_UNZIP_DIR} -type d | head -30
            sudo rm -f ${NDK_ZIP}
            exit 1
          fi
          echo "âœ… çœŸå®NDKæ ¹ç›®å½•ï¼š${REAL_NDK_DIR}"

          sudo chmod -R 777 ${REAL_NDK_DIR}
          sudo chown -R runner:runner ${REAL_NDK_DIR}

          echo -e "\nâœ… æ ¡éªŒå·¥å…·é“¾ç›®å½•..."
          ls -la ${REAL_NDK_DIR}/toolchains/
          if [ ! -d "${REAL_NDK_DIR}/toolchains/llvm/prebuilt" ]; then
            echo "âŒ å·¥å…·é“¾æ ¸å¿ƒç›®å½•ç¼ºå¤±ï¼æ‰“å°llvmç›®å½•å†…å®¹ï¼š"
            ls -la ${REAL_NDK_DIR}/toolchains/llvm/ 2>/dev/null || echo "llvmç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

          echo -e "\nğŸ” æŸ¥æ‰¾AArch64 clangç¼–è¯‘å™¨..."
          LLVM_BIN_DIR=$(find ${REAL_NDK_DIR}/toolchains/llvm/prebuilt -name "bin" -type d 2>/dev/null | head -n1)
          echo "llvmå·¥å…·é“¾binç›®å½•ï¼š${LLVM_BIN_DIR}"
          
          COMPILER=$(find ${LLVM_BIN_DIR} -name "aarch64-linux-android*-clang" -type f 2>/dev/null | head -n1)
          
          if [ -z "${COMPILER}" ] || [ ! -f "${COMPILER}" ]; then
            echo "ğŸ”¹ ç²¾å‡†æŸ¥æ‰¾å¤±è´¥ï¼Œå…¨è·¯å¾„å…œåº•æœç´¢..."
            COMPILER=$(find ${REAL_NDK_DIR} -name "aarch64-linux-android*-clang" -type f 2>/dev/null | head -n1)
          fi
          
          if [ -z "${COMPILER}" ] || [ ! -f "${COMPILER}" ]; then
            echo "âŒ æœªæ‰¾åˆ°AArch64 clangç¼–è¯‘å™¨ï¼æ‰“å°æ‰€æœ‰clangç›¸å…³å·¥å…·ï¼š"
            find ${REAL_NDK_DIR} -name "*clang*" -type f 2>/dev/null | head -20
            exit 1
          fi
          
          NDK_TOOLCHAIN_BIN=$(dirname ${COMPILER})
          echo "âœ… æ‰¾åˆ°AArch64ç¼–è¯‘å™¨ï¼š${COMPILER}"
          echo "âœ… å·¥å…·é“¾äºŒè¿›åˆ¶ç›®å½•ï¼š${NDK_TOOLCHAIN_BIN}"

          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_HOME=${REAL_NDK_DIR}" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH
          echo "âœ… NDKé…ç½®å®Œæˆï¼Œå·¥å…·é“¾è·¯å¾„ï¼š${NDK_TOOLCHAIN_BIN}"
        continue-on-error: false

      - name: Verify AArch64 Compiler (Full Check)
        run: |
          set -euo pipefail; set -x
          echo "=== ç¡®è®¤ç¯å¢ƒå˜é‡ ==="
          if [ -z "${NDK_HOME}" ] || [ -z "${NDK_TOOLCHAIN_BIN}" ]; then
            echo "Error: NDK_HOME/NDK_TOOLCHAIN_BINç¼ºå¤±ï¼"
            echo "å½“å‰ç¯å¢ƒå˜é‡ï¼š$(env | grep NDK)"
            exit 1
          fi
          echo "NDK_HOME: ${NDK_HOME}"
          echo "NDK_TOOLCHAIN_BIN: ${NDK_TOOLCHAIN_BIN}"

          echo "=== ç¡®è®¤ç¼–è¯‘å™¨ ==="
          if [ -z "${COMPILER:-}" ] || [ ! -f "${COMPILER:-}" ]; then
            echo "ğŸ”¹ ç¼–è¯‘å™¨å˜é‡æœªå®šä¹‰/æ— æ•ˆï¼Œå…œåº•æœç´¢..."
            COMPILER=$(find ${NDK_HOME} -name "aarch64-linux-android*-clang" -type f 2>/dev/null | head -n1)
            if [ -z "${COMPILER}" ]; then
              echo "Error: ç¼–è¯‘å™¨ç¼ºå¤±ï¼"
              exit 1
            fi
          fi
          echo "æ‰¾åˆ°ç¼–è¯‘å™¨ï¼š${COMPILER}"

          echo "=== æ ¡éªŒç¼–è¯‘å™¨å®Œæ•´æ€§ ==="
          if [ ! -x "${COMPILER}" ]; then
            echo "ç¼–è¯‘å™¨æ— æ‰§è¡Œæƒé™ï¼Œèµ‹æƒ..."
            sudo chmod 777 ${COMPILER}
            if [ ! -x "${COMPILER}" ]; then
              echo "Error: èµ‹æƒåä»æ— æ‰§è¡Œæƒé™ï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
              file ${COMPILER}
              exit 1
            fi
          fi
          ${COMPILER} --version >/dev/null 2>&1 || {
            echo "Error: ç¼–è¯‘å™¨è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼æ–‡ä»¶ä¿¡æ¯ï¼š"
            file ${COMPILER}
            exit 1
          }

          echo "=== éªŒè¯ç¼–è¯‘å™¨ç‰ˆæœ¬ ==="
          ${COMPILER} --version || {
            echo "Error: ç¼–è¯‘å™¨æ‰§è¡Œå¤±è´¥ï¼"
            echo "ç¼–è¯‘å™¨è„šæœ¬æ ¸å¿ƒå†…å®¹ï¼ˆå‰10è¡Œï¼‰ï¼š"
            head -n 10 ${COMPILER}
            exit 1
          }
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯é€šè¿‡"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Check & Collect All Header Files Paths
        run: |
          set -euo pipefail; set -x
          KERNEL_DIR=${KERNEL_DIR}
          PROJECT_ROOT=${PWD}
          CUSTOM_HEADER_PATHS=""

          # 1. æ ¡éªŒè‡ªèº«æºç æ–‡ä»¶
          if [ ! -f "${PROJECT_ROOT}/hello.c" ]; then
            echo "âŒ æ ¸å¿ƒæºç æ–‡ä»¶ hello.c ç¼ºå¤±ï¼"
            exit 1
          fi

          # 2. æ ¡éªŒå†…æ ¸æ ¸å¿ƒå¤´æ–‡ä»¶ï¼ˆè¦†ç›–æ‰€æœ‰éšè—å…³é”®ç›®å½•ï¼‰
          KERNEL_REQUIRED_HEADERS=(
            "${KERNEL_DIR}/include/linux/compiler.h"
            "${KERNEL_DIR}/arch/arm64/include/asm/rwonce.h"
            "${KERNEL_DIR}/include/uapi/linux/types.h"
            "${KERNEL_DIR}/include/asm-generic/bug.h"
          )
          for HEADER in "${KERNEL_REQUIRED_HEADERS[@]}"; do
            if [ ! -f "${HEADER}" ]; then
              echo "âŒ å†…æ ¸å¤´æ–‡ä»¶ ${HEADER} ç¼ºå¤±ï¼"
              find ${KERNEL_DIR} -name "$(basename ${HEADER})" -type f 2>/dev/null || echo "å†…æ ¸ç›®å½•æ— æ­¤æ–‡ä»¶"
              exit 1
            fi
          done

          # æ ¸å¿ƒä¼˜åŒ–ï¼šæŸ”æ€§æ ¡éªŒkpmodule.hï¼Œç»™å‡º3ç§ç²¾å‡†è§£å†³æ–¹æ³•ï¼Œé¿å…ç›²ç›®ç»ˆæ­¢
          echo -e "\nğŸ” æœç´¢è‡ªå®šä¹‰å¤´æ–‡ä»¶ kpmodule.h..."
          KP_MODULE_PATH=$(find ${PROJECT_ROOT} -name "kpmodule.h" -type f 2>/dev/null | head -n1)
          if [ -z "${KP_MODULE_PATH}" ]; then
            echo -e "\nâš ï¸  æœªæ‰¾åˆ°è‡ªå®šä¹‰å¤´æ–‡ä»¶ kpmodule.hï¼Œéœ€æ‰‹åŠ¨å¤„ç†ä»¥ä¸‹3ç§æƒ…å†µä¹‹ä¸€ï¼š"
            echo "  1. è‹¥éœ€è¦è¯¥æ–‡ä»¶ï¼šå°† kpmodule.h ä¸Šä¼ è‡³ä»£ç ä»“åº“ï¼ˆä»»æ„ç›®å½•å‡å¯ï¼Œé…ç½®ä¼šè‡ªåŠ¨è¯†åˆ«ï¼‰ï¼›"
            echo "  2. è‹¥æ–‡ä»¶åå†™é”™ï¼šä¿®æ­£æ–‡ä»¶åï¼ˆåŒºåˆ†å¤§å°å†™ï¼Œå¦‚ KPModule.h â‰  kpmodule.hï¼‰ï¼›"
            echo "  3. è‹¥æ— éœ€è¯¥æ–‡ä»¶ï¼šåˆ é™¤ hello.c ä¸­ '#include <kpmodule.h>' è¿™ä¸€è¡Œå¤šä½™å¼•ç”¨ï¼›"
            echo -e "\nâŒ è¯·å¤„ç†åé‡æ–°æäº¤ï¼Œå½“å‰æµç¨‹ç»ˆæ­¢ï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶å¯é€‰æ‹©è·³è¿‡è¯¥æ ¡éªŒï¼‰"
            exit 1
          fi
          # æ‰¾åˆ°æ–‡ä»¶åˆ™æ­£å¸¸æ·»åŠ è·¯å¾„
          KP_MODULE_DIR=$(dirname ${KP_MODULE_PATH})
          CUSTOM_HEADER_PATHS="-I${KP_MODULE_DIR}"
          echo "âœ… æ‰¾åˆ°è‡ªå®šä¹‰å¤´æ–‡ä»¶ kpmodule.hï¼Œè·¯å¾„ï¼š${KP_MODULE_PATH}ï¼Œæœç´¢è·¯å¾„ï¼š${KP_MODULE_DIR}"

          # 3. æ”¶é›†é¡¹ç›®å†…æ‰€æœ‰includeç›®å½•ï¼ˆæ‰¹é‡æ·»åŠ ï¼Œé€‚é…å¤šç›®å½•å­˜æ”¾ï¼‰
          PROJECT_INCLUDE_DIRS=$(find ${PROJECT_ROOT} -name "include" -type d 2>/dev/null | tr '\n' ' ')
          for DIR in ${PROJECT_INCLUDE_DIRS}; do
            CUSTOM_HEADER_PATHS="${CUSTOM_HEADER_PATHS} -I${DIR}"
          done
          echo "âœ… é¡¹ç›®å†…æ‰€æœ‰includeç›®å½•ï¼š${PROJECT_INCLUDE_DIRS}"

          # 4. æ‹¼æ¥å…¨é‡å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼Œå¯¼å‡ºä¸ºç¯å¢ƒå˜é‡ä¾›ç¼–è¯‘ä½¿ç”¨
          FULL_CFLAGS="-I${KERNEL_DIR}/include -I${KERNEL_DIR}/include/linux -I${KERNEL_DIR}/include/uapi -I${KERNEL_DIR}/arch/arm64/include -I${KERNEL_DIR}/arch/arm64/include/asm -I${KERNEL_DIR}/arch/arm64/include/uapi -I${KERNEL_DIR}/include/asm-generic -I${PROJECT_ROOT} ${CUSTOM_HEADER_PATHS}"
          echo "âœ… å…¨é‡å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼š${FULL_CFLAGS}"
          echo "FULL_CFLAGS=${FULL_CFLAGS}" >> $GITHUB_ENV
        continue-on-error: false

      # æ–°å¢ï¼šæ‰‹åŠ¨è§¦å‘æ—¶çš„å®¹é”™æ­¥éª¤ï¼Œè·³è¿‡kpmodule.hæ ¡éªŒï¼ˆè‡ªåŠ¨è§¦å‘ä¸ç”Ÿæ•ˆï¼‰
      - name: Skip kpmodule.h Check (Manual Trigger Only)
        if: github.event.inputs.skip_kpmodule_check == 'æ˜¯'
        run: |
          set -euo pipefail; set -x
          KERNEL_DIR=${KERNEL_DIR}
          PROJECT_ROOT=${PWD}
          # æ‹¼æ¥ä¸å«kpmodule.hçš„å…¨é‡è·¯å¾„ï¼ˆå‡è®¾æ— éœ€è¯¥æ–‡ä»¶ï¼Œå·²åˆ é™¤ä»£ç å¼•ç”¨ï¼‰
          FULL_CFLAGS="-I${KERNEL_DIR}/include -I${KERNEL_DIR}/include/linux -I${KERNEL_DIR}/include/uapi -I${KERNEL_DIR}/arch/arm64/include -I${KERNEL_DIR}/arch/arm64/include/asm -I${KERNEL_DIR}/arch/arm64/include/uapi -I${KERNEL_DIR}/include/asm-generic -I${PROJECT_ROOT}"
          echo "âš ï¸  å·²æ‰‹åŠ¨é€‰æ‹©è·³è¿‡kpmodule.hæ ¡éªŒï¼Œè‹¥ç¼–è¯‘å¤±è´¥è¯·ç¡®è®¤å·²åˆ é™¤ä»£ç ä¸­è¯¥æ–‡ä»¶çš„å¼•ç”¨"
          echo "FULL_CFLAGS=${FULL_CFLAGS}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Compile AArch64 Kernel Module
        run: |
          set -euo pipefail; set -x
          echo "=== ç¡®è®¤Makefile ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }
          echo "=== Makefileæ ¸å¿ƒå†…å®¹ï¼ˆå‰50è¡Œï¼‰ ==="
          head -n 50 Makefile 2>/dev/null

          # ä½¿ç”¨é¢„å…ˆç”Ÿæˆçš„å…¨é‡å¤´æ–‡ä»¶è·¯å¾„ï¼Œå¼ºåˆ¶ä¼ é€’ç»™ç¼–è¯‘å™¨
          PROJECT_ROOT=${PWD}
          echo "=== å¼€å§‹äº¤å‰ç¼–è¯‘ ==="
          make -j$(nproc) V=2 \
            CC="${COMPILER}" \
            CXX=$(find ${NDK_HOME} -name "aarch64-linux-android*-clang++" -type f 2>/dev/null | head -n1) \
            TARGET_ARCH=aarch64 \
            TARGET_API=31 \
            NDK="${NDK_HOME}" \
            CROSS_COMPILE=aarch64-linux-android- \
            KERNELDIR="${KERNEL_DIR}" \
            ARCH=arm64 \
            CFLAGS="${FULL_CFLAGS}" \
            EXTRA_CFLAGS="${FULL_CFLAGS}" || {
            echo "Error: ç¼–è¯‘å¤±è´¥ï¼"
            echo "å½“å‰ç”Ÿæ•ˆçš„å¤´æ–‡ä»¶æœç´¢è·¯å¾„ï¼š${FULL_CFLAGS}"
            exit 1
          }
          echo "âœ… AArch64å†…æ ¸æ¨¡å—ç¼–è¯‘æˆåŠŸï¼"
        continue-on-error: false

      - name: Run tests (if supported)
        run: |
          set -euo pipefail; set -x
          make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: |
          set -euo pipefail; set -x
          make distcheck
        continue-on-error: true
