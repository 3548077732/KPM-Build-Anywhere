name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      # ç¨³å®šä¾èµ–å®‰è£…ï¼ˆæ— æ”¹åŠ¨ï¼Œå·²éªŒè¯ç”Ÿæ•ˆï¼‰
      - name: Install base dependencies
        run: |
          sudo sed -i 's@http://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@http://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing --allow-releaseinfo-change
          sudo apt-get install -y --no-install-recommends build-essential wget unzip findutils curl
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          md5sum --version || echo "md5sumå·²å†…ç½®ï¼Œæ— éœ€å®‰è£…"
        continue-on-error: false

      # æ ¸å¿ƒç»ˆæä¿®å¤ï¼šå½»åº•è§£å†³NDKå‹ç¼©åŒ…æŸåé—®é¢˜ï¼ˆå¤šç»´åº¦ä¿éšœå®Œæ•´æ€§ï¼‰
      - name: Download & Extract Android NDK (r25c, Full Integrity)
        run: |
          # 1. ç²¾å‡†é…ç½®ï¼ˆå®˜æ–¹æƒå¨å‚æ•°ï¼Œæœç»ç‰ˆæœ¬/MD5åå·®ï¼‰
          NDK_VERSION="r25c"
          # å®˜æ–¹æƒå¨MD5ï¼ˆå®‰å“å®˜ç½‘å…¬ç¤ºï¼šLinux x86_64ç‰ˆr25cå”¯ä¸€æ­£ç¡®å€¼ï¼‰
          OFFICIAL_NDK_MD5="a9a4f843773848921983e148a937f08c"
          # åŒæºé…ç½®ï¼ˆé˜¿é‡Œäº‘é«˜é€Ÿ+è°·æ­Œå®˜æ–¹å…œåº•ï¼Œå‡ä¸ºæƒå¨æºï¼‰
          ALIYUN_NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          OFFICIAL_NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          NDK_ZIP="/home/runner/ndk.zip"
          NDK_DIR="/home/runner/android-ndk"
          MIN_NDK_SIZE=$((1024 * 1024 * 1024))  # NDKæœ€å°ä½“ç§¯ï¼ˆ1GBï¼Œä½äºåˆ™åˆ¤å®šæŸåï¼‰
          
          # 2. å‰ç½®æ¸…ç†ï¼ˆå¼ºåˆ¶åˆ é™¤æ—§æ–‡ä»¶ï¼Œæœç»æ®‹ç•™æŸååŒ…å¹²æ‰°ï¼‰
          echo "ğŸ”§ æ¸…ç†æ—§NDKæ–‡ä»¶ï¼Œç¡®ä¿å…¨æ–°ä¸‹è½½..."
          sudo rm -rf ${NDK_ZIP} ${NDK_DIR}
          # é‡å»ºç›®å½•+å…¨å±€æƒé™ï¼ˆå·²ç¨³å®šï¼Œæ— æ”¹åŠ¨ï¼‰
          sudo mkdir -p ${NDK_DIR}
          sudo chmod -R 777 ${NDK_DIR}
          sudo chown -R runner:runner ${NDK_DIR}
          ls -ld ${NDK_DIR}
          
          # 3. åŒæºä¸‹è½½+å¤šç»´åº¦å®Œæ•´æ€§æ ¡éªŒï¼ˆæ ¸å¿ƒä¿®å¤é€»è¾‘ï¼‰
          download_ndk() {
            local url=$1
            echo -e "\nğŸ“¥ ä»æºä¸‹è½½NDKï¼š${url}"
            # å¼ºåˆ¶å…¨æ–°ä¸‹è½½ï¼ˆæ¸…ç¼“å­˜+ç¦ç”¨cookie+é•¿è¶…æ—¶+å¤šé‡è¯•ï¼Œæœç»ä¸‹è½½æŸåï¼‰
            sudo rm -f ${NDK_ZIP}  # ä¸‹è½½å‰å†æ¬¡åˆ æ—§åŒ…ï¼ŒåŒé‡ä¿é™©
            sudo wget --no-cache --no-cookies --timeout=900 --tries=8 --show-progress --progress=bar:force \
              --no-check-certificate -O ${NDK_ZIP} ${url} || {
                echo "âŒ è¯¥æºä¸‹è½½å¤±è´¥ï¼Œåˆ‡æ¢å¤‡ç”¨æº..."
                return 1
              }
            
            # æ ¡éªŒ1ï¼šæ–‡ä»¶ä½“ç§¯ï¼ˆä½äº1GBç›´æ¥åˆ¤å®šæŸåï¼Œä¸åšMD5å†—ä½™æ ¡éªŒï¼‰
            local zip_size=$(du -b ${NDK_ZIP} | awk '{print $1}')
            if [ ${zip_size} -lt ${MIN_NDK_SIZE} ]; then
              echo "âŒ å‹ç¼©åŒ…ä½“ç§¯è¿‡å°ï¼ˆ${zip_size}å­—èŠ‚ < 1GBï¼‰ï¼Œåˆ¤å®šæŸå"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            
            # æ ¡éªŒ2ï¼šå®˜æ–¹MD5ç²¾å‡†åŒ¹é…ï¼ˆå”¯ä¸€æ ‡å‡†ï¼Œæœç»åŒ…ä¸ä¸€è‡´ï¼‰
            local calc_md5=$(md5sum ${NDK_ZIP} | awk '{print $1}')
            if [ "${calc_md5}" != "${OFFICIAL_NDK_MD5}" ]; then
              echo "âŒ MD5ä¸åŒ¹é…ï¼ˆé¢„æœŸï¼š${OFFICIAL_NDK_MD5}ï¼Œå®é™…ï¼š${calc_md5}ï¼‰ï¼ŒåŒ…æŸå"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            
            echo "âœ… ä¸‹è½½æˆåŠŸï¼Œå‹ç¼©åŒ…å®Œæ•´ï¼ˆä½“ç§¯ï¼š$(du -sh ${NDK_ZIP} | awk '{print $1}')ï¼ŒMD5åŒ¹é…ï¼‰"
            return 0
          }
          
          # ä¼˜å…ˆé˜¿é‡Œäº‘é«˜é€Ÿä¸‹è½½ï¼Œå¤±è´¥åˆ™åˆ‡æ¢è°·æ­Œå®˜æ–¹æºï¼ˆæƒå¨å…œåº•ï¼‰
          if download_ndk ${ALIYUN_NDK_URL}; then
            echo "âœ… ä¼˜å…ˆæºï¼ˆé˜¿é‡Œäº‘ï¼‰ä¸‹è½½æˆåŠŸ"
          elif download_ndk ${OFFICIAL_NDK_URL}; then
            echo "âœ… å¤‡ç”¨æºï¼ˆè°·æ­Œå®˜æ–¹ï¼‰ä¸‹è½½æˆåŠŸ"
          else
            echo "âŒ åŒæºä¸‹è½½å‡å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          
          # 4. å¼ºåˆ¶è§£å‹+äºŒæ¬¡èµ‹æƒï¼ˆå·²ç¨³å®šï¼Œæ— æ”¹åŠ¨ï¼‰
          echo -e "\nğŸ“¦ è§£å‹NDKåˆ° ${NDK_DIR}..."
          sudo unzip -o -u -v ${NDK_ZIP} -d ${NDK_DIR} || {
            echo "âŒ è§£å‹å¤±è´¥ï¼ŒæŸ¥çœ‹å‹ç¼©åŒ…å†…å®¹..."
            sudo unzip -l ${NDK_ZIP}
            sudo rm -f ${NDK_ZIP}
            exit 1
          }
          sudo chmod -R 777 ${NDK_DIR}
          sudo chown -R runner:runner ${NDK_DIR}
          
          # 5. æ ¸å¿ƒç›®å½•æ ¡éªŒï¼ˆå·²ç¨³å®šï¼Œæ— æ”¹åŠ¨ï¼‰
          echo -e "\nâœ… è§£å‹å®Œæˆï¼Œæ ¡éªŒæ ¸å¿ƒå·¥å…·é“¾ç›®å½•..."
          ls -la ${NDK_DIR}/toolchains/
          if [ ! -d "${NDK_DIR}/toolchains/llvm/prebuilt" ]; then
            echo "âŒ å·¥å…·é“¾æ ¸å¿ƒç›®å½•ç¼ºå¤±ï¼"
            ls -la ${NDK_DIR}/toolchains/llvm/
            exit 1
          fi
          
          # 6. ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå·²ç¨³å®šï¼Œæ— æ”¹åŠ¨ï¼‰
          NDK_TOOLCHAIN_BIN=$(find ${NDK_DIR} -name "aarch64-linux-android-clang" -type f | xargs dirname | head -n1)
          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_HOME=${NDK_DIR}" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH
          echo "âœ… NDKé…ç½®å®Œæˆï¼Œå·¥å…·é“¾è·¯å¾„ï¼š${NDK_TOOLCHAIN_BIN}"
        continue-on-error: false

      # ç¼–è¯‘å™¨æ ¡éªŒï¼ˆå·²ç¨³å®šï¼Œæ— æ”¹åŠ¨ï¼‰
      - name: Verify AArch64 Compiler (Full Check)
        run: |
          echo "=== ç¡®è®¤NDK_HOME ==="
          if [ -z "${NDK_HOME}" ]; then
            echo "Error: NDK_HOMEç¼ºå¤±ï¼"
            exit 1
          fi
          echo "NDK_HOME: ${NDK_HOME}"
          
          echo "=== æœç´¢ç¼–è¯‘å™¨ ==="
          COMPILER=$(find ${NDK_HOME} -name "aarch64-linux-android-clang" -type f | head -n1)
          if [ -z "${COMPILER}" ]; then
            echo "Error: ç¼–è¯‘å™¨ç¼ºå¤±ï¼"
            find ${NDK_HOME} -name "*clang*" -type f
            exit 1
          fi
          echo "æ‰¾åˆ°ç¼–è¯‘å™¨ï¼š${COMPILER}"
          
          echo "=== èµ‹æ‰§è¡Œæƒé™ ==="
          sudo chmod 777 ${COMPILER}
          if [ ! -x "${COMPILER}" ]; then
            echo "Error: æ— æ‰§è¡Œæƒé™ï¼"
            exit 1
          fi
          
          echo "=== éªŒè¯ç‰ˆæœ¬ ==="
          ${COMPILER} --version || {
            echo "Error: ç¼–è¯‘å™¨æ‰§è¡Œå¤±è´¥ï¼"
            file ${COMPILER}
            exit 1
          }
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯é€šè¿‡"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
        continue-on-error: false

      # ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼ˆå·²ç¨³å®šï¼Œæ— æ”¹åŠ¨ï¼‰
      - name: Compile AArch64 Kernel Module
        run: |
          echo "=== ç¡®è®¤Makefile ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }

          echo "=== å¼€å§‹äº¤å‰ç¼–è¯‘ ==="
          make -j$(nproc) V=1 \
            CC="${COMPILER}" \
            CXX=$(find ${NDK_HOME} -name "aarch64-linux-android-clang++" -type f | head -n1) \
            TARGET_API=31
        continue-on-error: false

      # å®¹é”™æ­¥éª¤ï¼ˆå·²ç¨³å®šï¼Œæ— æ”¹åŠ¨ï¼‰
      - name: Run tests (if supported)
        run: make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: make distcheck
        continue-on-error: true
