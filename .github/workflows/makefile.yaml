# å·¥ä½œæµç¨‹åç§°ï¼ˆè´´åˆä»“åº“æ¨¡æ¿å®šä½ï¼‰
name: KPM-Build-Anywhere è½»é‡åŒ–è‡ªåŠ¨åŒ–æ„å»ºï¼ˆç¼“å­˜ä¿®å¤+è¯­æ³•ä¿®æ­£ç‰ˆï¼‰
# è§¦å‘è§„åˆ™ï¼šåŒ¹é…ä»“åº“åˆ†æ”¯è§„èŒƒï¼ˆmainç”Ÿäº§/developå¼€å‘ï¼‰
on:
  push:
    branches: [main, develop] # ä»…ç›‘å¬æ ¸å¿ƒåˆ†æ”¯æ¨é€
    paths-ignore: # å¿½ç•¥æ–‡æ¡£/é…ç½®æ–‡ä»¶å˜æ›´ï¼Œé¿å…æ— æ•ˆæ„å»º
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main, develop] # æ ¸å¿ƒåˆ†æ”¯PRè§¦å‘æ„å»ºæ ¡éªŒ

jobs:
  # æ ¸å¿ƒä»»åŠ¡ï¼šè·¨å¹³å°å…¼å®¹æ„å»ºï¼ˆé€‚é…ä»“åº“Build-Anywhereç‰¹æ€§ï¼Œä¼˜å…ˆç¨³åæ‰©å¹³å°ï¼‰
  light-build:
    runs-on: ubuntu-latest # ä¼˜å…ˆUbuntuï¼ˆç¼“å­˜ç¨³å®š+æ„å»ºå¿«é€Ÿï¼Œé€‚é…è½»é‡åŒ–éœ€æ±‚ï¼‰
    # å¯é€‰æ‰©å±•è·¨å¹³å°ï¼ˆéœ€ç¨³å®šåå¼€å¯ï¼Œé¿å…ç¼“å­˜å‹åŠ›ï¼Œæ³¨é‡Šå¤‡ç”¨ï¼‰
    # strategy:
    #   fail-fast: true
    #   matrix:
    #     os: [ubuntu-latest, windows-latest, macos-latest]
    #     node-version: [18.x]

    steps:
      ###########################################################################
      # æ­¥éª¤1ï¼šæ‹‰å–ä»“åº“æºç ï¼ˆé€‚é…æ¨¡æ¿ä»“åº“ï¼Œç²¾ç®€æ‹‰å–è€—æ—¶ï¼‰
      ###########################################################################
      - name: æ‹‰å–ä»“åº“æ¨¡æ¿æœ€æ–°ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # ä»…æ‹‰å–æœ€æ–°æäº¤ï¼Œå¥‘åˆè½»é‡åŒ–æ„å»ºé«˜æ•ˆéœ€æ±‚

      ###########################################################################
      # æ­¥éª¤2ï¼šé…ç½®Nodeç¯å¢ƒï¼ˆç¼“å­˜æŠ¥é”™æ ¸å¿ƒä¿®å¤ï¼Œé€‚é…æ¨¡æ¿é¡¹ç›®ä¾èµ–ï¼‰
      ###########################################################################
      - name: é…ç½®Node.jsç¯å¢ƒï¼ˆç¼“å­˜ä¼˜åŒ–+æ¨¡æ¿é€‚é…ï¼‰
        uses: actions/setup-node@v4
        with:
          node-version: 18.x # ğŸ‘‰ å¿…å¾®è°ƒï¼šé¡¹ç›®å®é™…Nodeç‰ˆæœ¬ï¼ˆæœ¬åœ°node -væŸ¥çœ‹ï¼‰
          cache: 'npm' # åŒ…ç®¡ç†å™¨ï¼ˆæ¨¡æ¿é¡¹ç›®å¸¸ç”¨npmï¼Œyarnæ”¹yarnã€pnpmæ”¹pnpmï¼‰
          # ç¼“å­˜ä¿®å¤1ï¼šå»¶é•¿è¶…æ—¶è‡³10åˆ†é’Ÿï¼Œé¿å…å¤§ä¾èµ–ä¸Šä¼ ä¸­æ–­
          cache-options:
            timeout-minutes: 10
          # ç¼“å­˜ä¿®å¤2ï¼šç²¾å‡†ç¼“å­˜ï¼Œä»…å…³è”é”æ–‡ä»¶ï¼Œå‡å°‘æ¨¡æ¿é¡¹ç›®ç¼“å­˜ä½“ç§¯
          cache-dependency-path: package-lock.json # npmâ†’package-lock.jsonï¼›yarnâ†’yarn.lockï¼›pnpmâ†’pnpm-lock.yaml

      ###########################################################################
      # æ­¥éª¤3ï¼šå®‰è£…ä¾èµ–+å†—ä½™æ¸…ç†ï¼ˆè½»é‡åŒ–æ ¸å¿ƒï¼Œå¤§å¹…ç¼©ç¼“å­˜ä½“ç§¯ï¼‰
      ###########################################################################
      - name: å®‰è£…ä¾èµ–ï¼ˆè½»é‡åŒ–é€‚é…ï¼‰+ æ¸…ç†å†—ä½™
        run: |
          # ä»…è£…ç”Ÿäº§ä¾èµ–ï¼ˆå‰”é™¤å¼€å‘ä¾èµ–ï¼Œå¥‘åˆæ¨¡æ¿è½»é‡åŒ–æ„å»ºï¼Œç¼“å­˜ä½“ç§¯é™50%+ï¼‰
          npm install --production
          # æ¸…ç†npmå†—ä½™ç¼“å­˜+æ—¥å¿—ï¼Œé¿å…ç¼“å­˜å †ç§¯æŠ¥é”™
          npm cache clean --force
          rm -rf ~/.npm/_logs
          # æ¸…ç†æ¨¡æ¿é¡¹ç›®å¯èƒ½çš„æ„å»ºæ®‹ç•™ç¼“å­˜
          rm -rf node_modules/.cache 2>/dev/null || true
          rm -rf .temp 2>/dev/null || true

      ###########################################################################
      # æ­¥éª¤4ï¼šè½»é‡åŒ–æ„å»ºï¼ˆé€‚é…ä»“åº“æ¨¡æ¿æ ¸å¿ƒæ„å»ºé€»è¾‘ï¼‰
      ###########################################################################
      - name: æ‰§è¡Œæ¨¡æ¿é¡¹ç›®æ„å»ºï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        run: makefile # ğŸ‘‰ å¿…å¾®è°ƒï¼šé¡¹ç›®å®é™…æ„å»ºå‘½ä»¤ï¼ˆæ¨¡æ¿å¸¸ç”¨buildï¼ŒæŒ‰éœ€æ”¹ï¼‰
        env:
          NODE_ENV: production # å›ºå®šç”Ÿäº§ç¯å¢ƒï¼Œé€‚é…æ¨¡æ¿å‘å¸ƒéœ€æ±‚
          BUILD_TARGET: default # æ¨¡æ¿é€šç”¨æ„å»ºç›®æ ‡ï¼Œå¯æŒ‰éœ€åŠ é¡¹ç›®ä¸“å±å˜é‡

      ###########################################################################
      # æ­¥éª¤5ï¼šæ„å»ºç»“æœæ ¡éªŒï¼ˆè½»é‡åŒ–æ ¡éªŒï¼Œç¡®ä¿äº§ç‰©å¯ç”¨ï¼‰
      ###########################################################################
      - name: æ ¡éªŒæ„å»ºäº§ç‰©å®Œæ•´æ€§
        run: |
          # æ ¡éªŒäº§ç‰©ç›®å½•å­˜åœ¨ï¼ˆdistä¸ºæ¨¡æ¿é»˜è®¤äº§ç‰©ç›®å½•ï¼Œä¸æ„å»ºå‘½ä»¤å¯¹åº”ï¼‰
          if [ ! -d "dist" ]; then echo "äº§ç‰©ç›®å½•ç¼ºå¤±ï¼Œæ„å»ºå¤±è´¥"; exit 1; fi
          # æ ¡éªŒæ ¸å¿ƒäº§ç‰©æ–‡ä»¶å­˜åœ¨ï¼ˆæŒ‰éœ€åŠ æ¨¡æ¿é¡¹ç›®å…³é”®äº§ç‰©ï¼Œå¦‚index.htmlï¼‰
          if [ ! -f "dist/index.html" ]; then echo "æ ¸å¿ƒäº§ç‰©ç¼ºå¤±"; exit 1; fi

      ###########################################################################
      # æ­¥éª¤6ï¼šmainåˆ†æ”¯ä¸“å±ï¼šäº§ç‰©æ‰“åŒ…+ä¸Šä¼ ï¼ˆé€‚é…æ¨¡æ¿ç”Ÿäº§å‘å¸ƒéœ€æ±‚ï¼‰
      ###########################################################################
      - name: æ‰“åŒ…ç”Ÿäº§ç¯å¢ƒæ„å»ºäº§ç‰©ï¼ˆä»…mainåˆ†æ”¯ï¼‰
        if: github.ref == 'refs/heads/main'
        run: |
          # ğŸ‘‰ å¿…å¾®è°ƒï¼šdistæ”¹ä¸ºé¡¹ç›®å®é™…äº§ç‰©ç›®å½•ï¼ˆæ¨¡æ¿é»˜è®¤distï¼ŒæŒ‰éœ€æ”¹ï¼‰
          zip -r kpm-build-output-${{ github.sha }}.zip dist/
          echo "è½»é‡åŒ–äº§ç‰©æ‰“åŒ…å®Œæˆï¼škpm-build-output-${{ github.sha }}.zip"

      - name: ä¸Šä¼ ç”Ÿäº§äº§ç‰©ï¼ˆæ”¯æŒç›´æ¥ä¸‹è½½å‘å¸ƒï¼‰
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: kpm-build-final-${{ github.sha }}
          path: kpm-build-output-${{ github.sha }}.zip
          retention-days: 30 # äº§ç‰©ä¿ç•™30å¤©ï¼Œå¥‘åˆæ¨¡æ¿é¡¹ç›®è¿­ä»£èŠ‚å¥
          if-no-files-found: error # æ— äº§ç‰©ç›´æ¥æŠ¥é”™ï¼ŒåŠæ—¶æ‹¦æˆªå¼‚å¸¸

      ###########################################################################
      # æ­¥éª¤7ï¼šmainåˆ†æ”¯ä¸“å±ï¼šè‡ªåŠ¨æ‰“ç‰ˆæœ¬+åˆ›å»ºReleaseï¼ˆè¯­æ³•ä¿®æ­£æ ¸å¿ƒï¼Œç¨³å®šæ— é”™ï¼‰
      ###########################################################################
      - name: ç”Ÿæˆè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
        id: gen-version
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          # è¯­ä¹‰åŒ–ç‰ˆæœ¬è‡ªåŠ¨é€’å¢ï¼ˆæ— å†å²æ ‡ç­¾ä»v1.0.0å¼€å§‹ï¼Œé€‚é…æ¨¡æ¿ç‰ˆæœ¬ç®¡ç†ï¼‰
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          new_tag=$(echo $latest_tag | awk -F. '{printf "%s.%s.%d", $1, $2, $3+1}')
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          git tag $new_tag && git push origin $new_tag

      - name: åˆ›å»ºGitHub Releaseï¼ˆé™„å¸¦äº§ç‰©ï¼Œè¯­æ³•ä¿®æ­£ç‰ˆï¼‰
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v2 # ç”¨æˆç†ŸActionï¼Œé¿å…è¯­æ³•é”™è¯¯
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # å†…ç½®å¯†é’¥ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
        with:
          tag_name: ${{ steps.gen-version.outputs.new_tag }} # å…³è”ä¸Šä¸€æ­¥ç”Ÿæˆçš„ç‰ˆæœ¬
          release_name: KPMæ„å»ºäº§ç‰©å‘å¸ƒ ${{ steps.gen-version.outputs.new_tag }}
          body: |
            ğŸ“¦ å‘å¸ƒç‰ˆæœ¬ï¼š${{ steps.gen-version.outputs.new_tag }}
            ğŸ“ æ„å»ºæäº¤å“ˆå¸Œï¼š${{ github.sha }}
            â° å‘å¸ƒæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
            ğŸ“Œ äº§ç‰©è¯´æ˜ï¼šè½»é‡åŒ–æ„å»ºé™æ€èµ„æºï¼Œé€‚é…è·¨å¹³å°éƒ¨ç½²éœ€æ±‚
          files: kpm-build-output-${{ github.sha }}.zip # é™„å¸¦æ‰“åŒ…äº§ç‰©
          draft: false # éè‰ç¨¿å‘å¸ƒ
          prerelease: false # æ­£å¼ç‰ˆæœ¬
