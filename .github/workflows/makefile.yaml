name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      # æ­¥éª¤1ï¼šå®‰è£…åŸºç¡€ä¾èµ–ï¼ˆå«ä¸‹è½½è§£å‹å·¥å…·+ç¼–è¯‘å·¥å…·ï¼‰
      - name: Install base dependencies
        run: |
          sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing
          # æ–°å¢wget/unzipç”¨äºæ‰‹åŠ¨ä¸‹è½½è§£å‹NDKï¼Œé¿å…ä¾èµ–Action
          sudo apt-get install -y --no-install-recommends build-essential wget unzip
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
        continue-on-error: false

      # æ­¥éª¤2ï¼šæ‰‹åŠ¨ä¸‹è½½+è§£å‹NDKï¼ˆç¨³å®šå¯æ§ï¼Œæ˜¾å¼é…ç½®è·¯å¾„ï¼‰
      - name: Download & Extract Android NDK (r26b)
        run: |
          # é”å®šNDK r26bï¼ˆç¨³å®šç‰ˆï¼Œå†…ç½®aarch64å·¥å…·é“¾ï¼Œé€‚é…API31ï¼‰
          NDK_VERSION="r26b"
          NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          NDK_INSTALL_DIR="/opt/android-ndk-${NDK_VERSION}"  # å›ºå®šå®‰è£…è·¯å¾„ï¼Œæ— æ­§ä¹‰

          # 1. ä¸‹è½½NDKï¼ˆåŠ è¶…æ—¶é‡è¯•ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨ï¼‰
          echo "ğŸ“¥ ä¸‹è½½NDK ${NDK_VERSION}..."
          wget -q --timeout=300 --tries=3 -O ndk.zip "${NDK_URL}"
          if [ $? -ne 0 ]; then
            echo "Error: NDKä¸‹è½½å¤±è´¥ï¼Œæ¢å¤‡ç”¨æºé‡è¯•..."
            # å¤‡ç”¨æºï¼ˆé˜¿é‡Œäº‘é•œåƒï¼Œè§£å†³è°·æ­Œæºè®¿é—®æ…¢ï¼‰
            NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
            wget -q --timeout=300 --tries=3 -O ndk.zip "${NDK_URL}" || exit 1
          fi

          # 2. è§£å‹NDKåˆ°å›ºå®šç›®å½•
          echo "ğŸ“¦ è§£å‹NDKåˆ° ${NDK_INSTALL_DIR}..."
          unzip -q ndk.zip -d /opt/  # è§£å‹åè‡ªåŠ¨ç”Ÿæˆ ${NDK_INSTALL_DIR}
          if [ ! -d "${NDK_INSTALL_DIR}" ]; then
            echo "Error: NDKè§£å‹å¤±è´¥ï¼Œç›®å½•ä¸å­˜åœ¨ï¼"
            ls -la /opt/  # æ‰“å°/optç›®å½•ï¼Œæ’æŸ¥è§£å‹é—®é¢˜
            exit 1
          fi

          # 3. æ˜¾å¼è®¾ç½®NDK_HOMEç¯å¢ƒå˜é‡ï¼ˆå…¨å±€ç”Ÿæ•ˆï¼Œåç»­æ­¥éª¤ç›´æ¥ç”¨ï¼‰
          echo "ğŸ”§ é…ç½®NDK_HOMEç¯å¢ƒå˜é‡..."
          echo "NDK_HOME=${NDK_INSTALL_DIR}" >> $GITHUB_ENV
          echo "${NDK_INSTALL_DIR}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
          export NDK_HOME="${NDK_INSTALL_DIR}"  # å½“å‰æ­¥éª¤å³æ—¶ç”Ÿæ•ˆ
          echo "âœ… NDKé…ç½®å®Œæˆï¼ŒNDK_HOME=${NDK_HOME}"
        continue-on-error: false

      # æ­¥éª¤3ï¼šæ ¡éªŒå·¥å…·é“¾å®Œæ•´æ€§ï¼ˆç¡®ä¿ç¼–è¯‘å™¨å¯ç”¨ï¼‰
      - name: Verify NDK Toolchain
        run: |
          # 1. å†æ¬¡ç¡®è®¤NDK_HOMEå­˜åœ¨ï¼ˆåŒé‡ä¿é™©ï¼‰
          if [ -z "${NDK_HOME}" ]; then
            echo "Error: NDK_HOMEæœªé…ç½®ï¼"
            exit 1
          fi
          echo "âœ… NDK_HOMEç¡®è®¤ï¼š${NDK_HOME}"

          # 2. ç¡®è®¤å·¥å…·é“¾ç›®å½•å­˜åœ¨
          NDK_TOOLCHAIN_BIN="${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          if [ ! -d "${NDK_TOOLCHAIN_BIN}" ]; then
            echo "Error: å·¥å…·é“¾ç›®å½•ä¸å­˜åœ¨ï¼"
            ls -la "${NDK_HOME}/toolchains/llvm/prebuilt/"
            exit 1
          fi
          echo "âœ… å·¥å…·é“¾ç›®å½•ç¡®è®¤ï¼š${NDK_TOOLCHAIN_BIN}"

          # 3. éªŒè¯aarch64ç¼–è¯‘å™¨å­˜åœ¨ä¸”å¯æ‰§è¡Œ
          COMPILER="${NDK_TOOLCHAIN_BIN}/aarch64-linux-android-clang"
          if [ ! -f "${COMPILER}" ] || [ ! -x "${COMPILER}" ]; then
            echo "Error: aarch64ç¼–è¯‘å™¨ç¼ºå¤±æˆ–ä¸å¯æ‰§è¡Œï¼"
            ls -la "${NDK_TOOLCHAIN_BIN}" | grep "aarch64-linux-android-clang"
            exit 1
          fi
          # æ‰“å°ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼Œæœ€ç»ˆç¡®è®¤å¯ç”¨
          echo -e "\n=== ç¼–è¯‘å™¨ç‰ˆæœ¬ ==="
          ${COMPILER} --version || exit 1
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯é€šè¿‡"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV  # æŒä¹…åŒ–ç¼–è¯‘å™¨è·¯å¾„
        continue-on-error: false

      # æ­¥éª¤4ï¼šç¼–è¯‘å®‰å“å†…æ ¸æ¨¡å—ï¼ˆç»å¯¹è·¯å¾„ç¼–è¯‘å™¨ï¼Œé›¶åå·®ï¼‰
      - name: Compile AArch64 Kernel Module
        run: |
          echo "=== ç¡®è®¤Makefileå­˜åœ¨ ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }

          echo "=== å¼€å§‹äº¤å‰ç¼–è¯‘ ==="
          # ç”¨ç»å¯¹è·¯å¾„ç¼–è¯‘å™¨ï¼Œå¼ºåˆ¶æŒ‡å®šAPI31ï¼Œé€‚é…å†…æ ¸æ¨¡å—ç¼–è¯‘
          make -j$(nproc) V=1 \
            CC="${COMPILER}" \
            CXX="${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android-clang++" \
            TARGET_API=31
        continue-on-error: false

      # å†…æ ¸æ¨¡å—é¡¹ç›®æ— éœ€æµ‹è¯•/å‘å¸ƒæ ¡éªŒï¼ŒæŒ‰éœ€ä¿ç•™
      - name: Run tests (if supported)
        run: make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: make distcheck
        continue-on-error: true
