name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      # 关键修复：依赖安装步骤（格式绝对规范，杜绝空包名识别）
      - name: Install build dependencies
        run: |
          # 换源+强制更新缓存（彻底解决源同步不全问题）
          sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo sed -i 's@security.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing --allow-releaseinfo-change --force-yes
          sudo apt-get autoremove -y && sudo apt-get clean
          # 核心修复：依赖列表无多余空格，反斜杠后直接跟包名，无空行
          sudo apt-get install -y --no-install-recommends build-essential libc6-dev
          # 校验工具安装成功
          gcc --version || exit 1
          make --version || exit 1
        continue-on-error: false

      - name: Compile project
        run: |
          echo "=== Check Makefile ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }
          echo "=== Start compiling ==="
          make -j$(nproc) V=1
        continue-on-error: false

      - name: Run unit tests
        run: make check
        continue-on-error: false

      # 若项目不支持distcheck，直接注释此步骤
      - name: Verify release package
        run: make distcheck
        continue-on-error: true
