name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            wget unzip  # 新增：用于下载解压NDK
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
        continue-on-error: false

      # 关键新增：安装安卓NDK（匹配API31，含aarch64-linux-android31-clang）
      - name: Install Android NDK (r25c for API31)
        run: |
          # 下载稳定版NDK r25c（适配API31，兼容aarch64交叉编译）
          NDK_VERSION=r25c
          NDK_URL=https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          wget -q -O ndk.zip ${NDK_URL}
          # 解压NDK到指定目录（路径简化，便于配置）
          unzip -q ndk.zip -d /opt/
          NDK_HOME=/opt/android-ndk-${NDK_VERSION}
          # 配置环境变量：将NDK工具链路径加入PATH，让make找到编译器
          echo "NDK_HOME=${NDK_HOME}" >> $GITHUB_ENV
          echo "${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
          # 验证编译器是否可识别
          aarch64-linux-android31-clang --version || exit 1
        continue-on-error: false

      - name: Compile Android kernel module
        run: |
          echo "=== Check Makefile ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }
          echo "=== Start cross-compiling (aarch64) ==="
          # 显式指定编译器（双重保障，避免Makefile路径硬编码问题）
          make -j$(nproc) V=1 CC=aarch64-linux-android31-clang
        continue-on-error: false

      - name: Run unit tests (if supported)
        run: make check
        continue-on-error: true  # 内核模块项目可能无check命令，容错

      - name: Verify release package (if supported)
        run: make distcheck
        continue-on-error: true
