name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing
          sudo apt-get install -y --no-install-recommends build-essential wget unzip findutils
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
        continue-on-error: false

      # æ ¸å¿ƒä¿®å¤ï¼šæ¢ç”¨æˆ·å¯å†™ç›®å½•è§£å‹+åŠ sudoæƒé™+å¼ºåŒ–å‹ç¼©åŒ…æ ¡éªŒ
      - name: Download & Extract Android NDK (r25c)
        run: |
          NDK_VERSION="r25c"
          # é˜¿é‡Œäº‘é•œåƒï¼ˆé«˜é€Ÿç¨³å®šï¼Œé¿å…å‹ç¼©åŒ…æŸåï¼‰
          NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          # å…³é”®ï¼šæ¢runnerç”¨æˆ·å¯å†™ç›®å½•ï¼ˆ~/.android-ndkï¼‰ï¼Œå½»åº•è§„é¿/optæƒé™é—®é¢˜
          NDK_INSTALL_DIR="${HOME}/.android-ndk-${NDK_VERSION}"
          NDK_ZIP_PATH="${HOME}/ndk.zip"

          # 1. ç¨³å®šä¸‹è½½ï¼ˆæ˜¾ç¤ºæ–‡ä»¶å¤§å°+è¿›åº¦ï¼Œä¸‹è½½åæ ¡éªŒæ–‡ä»¶éç©ºï¼‰
          echo "ğŸ“¥ ä¸‹è½½NDK ${NDK_VERSION}..."
          wget -O "${NDK_ZIP_PATH}" --timeout=600 --tries=5 --show-progress --progress=bar:force "${NDK_URL}" || {
            echo "å¤‡ç”¨æºé‡è¯•..."
            NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
            wget -O "${NDK_ZIP_PATH}" --timeout=600 --tries=5 --show-progress --progress=bar:force "${NDK_URL}" || exit 1
          }
          # æ ¡éªŒå‹ç¼©åŒ…éç©ºï¼ˆé¿å…ä¸‹è½½ç©ºæ–‡ä»¶ï¼‰
          if [ ! -s "${NDK_ZIP_PATH}" ]; then
            echo "Error: NDKå‹ç¼©åŒ…ä¸ºç©ºï¼Œä¸‹è½½å¤±è´¥ï¼"
            rm -f "${NDK_ZIP_PATH}"
            exit 1
          fi
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œå‹ç¼©åŒ…å¤§å°ï¼š$(du -sh "${NDK_ZIP_PATH}" | awk '{print $1}')"

          # 2. è§£å‹ï¼ˆåŠ sudoä¿éšœæƒé™ï¼Œæ‰“å°è¯¦ç»†æ—¥å¿—ï¼Œé¿å…é™é»˜å¤±è´¥ï¼‰
          echo "ğŸ“¦ è§£å‹NDKåˆ° ${NDK_INSTALL_DIR}..."
          # å…ˆåˆ é™¤æ—§ç›®å½•ï¼ˆé¿å…æ®‹ç•™å¹²æ‰°ï¼‰
          rm -rf "${NDK_INSTALL_DIR}"
          # è§£å‹æ—¶æ‰“å°è¯¦ç»†è¿‡ç¨‹ï¼Œä¾¿äºå®šä½å¤±è´¥åŸå› ï¼ˆå»æ‰-qé™é»˜æ¨¡å¼ï¼‰
          sudo unzip -v "${NDK_ZIP_PATH}" -d "${HOME}/" || {
            echo "Error: NDKè§£å‹å¤±è´¥ï¼å‹ç¼©åŒ…å¯èƒ½æŸåï¼Œé‡æ–°ä¸‹è½½..."
            rm -f "${NDK_ZIP_PATH}"
            exit 1
          }
          # è§£å‹åç›®å½•åå›ºå®šä¸ºandroid-ndk-${NDK_VERSION}ï¼Œç¡®è®¤å­˜åœ¨
          if [ ! -d "${NDK_INSTALL_DIR}" ]; then
            echo "Error: è§£å‹ç›®å½•ä¸å­˜åœ¨ï¼Œæ‰“å°ç”¨æˆ·ç›®å½•ä¸‹NDKç›¸å…³æ–‡ä»¶ï¼š"
            ls -la "${HOME}/" | grep "android-ndk"
            exit 1
          fi
          # ç»™è§£å‹ç›®å½•èµ‹runnerç”¨æˆ·æƒé™ï¼ˆé¿å…sudoè§£å‹åæƒé™å½’å±rootï¼‰
          sudo chown -R runner:runner "${NDK_INSTALL_DIR}"
          echo "âœ… NDKè§£å‹å®Œæˆï¼Œç›®å½•æƒé™å·²ä¿®æ­£"

          # 3. åŠ¨æ€åŒ¹é…å·¥å…·é“¾è·¯å¾„
          PREBUILT_DIR="${NDK_INSTALL_DIR}/toolchains/llvm/prebuilt"
          SYSTEM_DIR=$(ls -d ${PREBUILT_DIR}/linux-* 2>/dev/null | head -n1)
          if [ -z "${SYSTEM_DIR}" ]; then
            echo "Error: å·¥å…·é“¾ç³»ç»Ÿç›®å½•æœªæ‰¾åˆ°ï¼Œæ‰“å°prebuiltç›®å½•ï¼š"
            ls -la ${PREBUILT_DIR}/
            exit 1
          fi
          NDK_TOOLCHAIN_BIN="${SYSTEM_DIR}/bin"
          echo "âœ… å·¥å…·é“¾è·¯å¾„ï¼š${NDK_TOOLCHAIN_BIN}"

          # 4. é…ç½®ç¯å¢ƒ+èµ‹ç¼–è¯‘å™¨æ‰§è¡Œæƒé™
          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_HOME=${NDK_INSTALL_DIR}" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH
          chmod +x ${NDK_TOOLCHAIN_BIN}/*clang* 2>/dev/null
          echo "âœ… NDKé…ç½®å®Œæˆ"
        continue-on-error: false

      - name: Verify AArch64 Compiler
        run: |
          echo "=== å…¨å±€æœç´¢aarch64ç¼–è¯‘å™¨ ==="
          COMPILER=$(find ${NDK_HOME} -name "aarch64-linux-android-clang" -type f | head -n1)
          if [ -z "${COMPILER}" ]; then
            echo "Error: æœªæ‰¾åˆ°ç¼–è¯‘å™¨ï¼Œæ‰“å°å·¥å…·é“¾ç›®å½•æ–‡ä»¶ï¼š"
            ls -la ${NDK_TOOLCHAIN_BIN}/ | grep "clang"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨ï¼š${COMPILER}"

          if [ ! -x "${COMPILER}" ]; then
            echo "èµ‹æ‰§è¡Œæƒé™..."
            chmod +x "${COMPILER}"
          fi

          echo -e "\n=== ç¼–è¯‘å™¨ç‰ˆæœ¬ ==="
          ${COMPILER} --version || {
            echo "Error: ç¼–è¯‘å™¨æ‰§è¡Œå¤±è´¥ï¼"
            file "${COMPILER}"
            exit 1
          }
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯é€šè¿‡"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Compile AArch64 Kernel Module
        run: |
          echo "=== ç¡®è®¤Makefileå­˜åœ¨ ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }

          echo "=== å¼€å§‹äº¤å‰ç¼–è¯‘ ==="
          make -j$(nproc) V=1 \
            CC="${COMPILER}" \
            CXX=$(find ${NDK_HOME} -name "aarch64-linux-android-clang++" -type f | head -n1) \
            TARGET_API=31
        continue-on-error: false

      - name: Run tests (if supported)
        run: make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: make distcheck
        continue-on-error: true
