name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing
          sudo apt-get install -y --no-install-recommends build-essential
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
        continue-on-error: false

      # å®‰è£…NDKï¼ˆé”å®šr26bï¼ŒActionè‡ªåŠ¨æ³¨å…¥NDK_HOMEç¯å¢ƒå˜é‡ï¼‰
      - name: Setup Android NDK (r26b)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b
          add-to-path: false  # æ‰‹åŠ¨ç²¾å‡†é…ç½®è·¯å¾„ï¼Œé¿å…è‡ªåŠ¨é…ç½®åå·®
        continue-on-error: false

      # æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€æ‹¼æ¥å·¥å…·é“¾è·¯å¾„+ä¸¥æ ¼è·¯å¾„æ ¡éªŒ
      - name: Configure & Verify NDK Toolchain
        run: |
          # 1. ç¡®è®¤NDK_HOMEå·²æ­£ç¡®æ³¨å…¥ï¼ˆå…³é”®å‰æï¼‰
          if [ -z "${NDK_HOME}" ]; then
            echo "Error: NDK_HOME environment variable not found!"
            exit 1
          fi
          echo "âœ… NDKå®‰è£…è·¯å¾„ç¡®è®¤ï¼š${NDK_HOME}"

          # 2. åŠ¨æ€æ‹¼æ¥å·¥å…·é“¾äºŒè¿›åˆ¶ç›®å½•ï¼ˆåŸºäºNDK_HOMEï¼Œæ— ç¡¬ç¼–ç ï¼‰
          NDK_TOOLCHAIN_BIN="${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          echo "ğŸ”§ å·¥å…·é“¾ç›®æ ‡è·¯å¾„ï¼š${NDK_TOOLCHAIN_BIN}"

          # 3. ä¸¥æ ¼æ ¡éªŒè·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œé¿å…æ— æ•ˆè®¿é—®
          if [ ! -d "${NDK_TOOLCHAIN_BIN}" ]; then
            echo "Error: Toolchain directory not exists!"
            # æ‰“å°NDKæ ¹ç›®å½•ç»“æ„ï¼Œè¾…åŠ©æ’æŸ¥è·¯å¾„åå·®
            echo -e "\n=== NDKæ ¹ç›®å½•ä¸‹toolchainsç»“æ„ ==="
            ls -la "${NDK_HOME}/toolchains/llvm/prebuilt/"
            exit 1
          fi
          echo "âœ… å·¥å…·é“¾ç›®å½•å­˜åœ¨"

          # 4. é…ç½®ç¯å¢ƒå˜é‡ï¼Œç¡®ä¿å…¨å±€å¯è°ƒç”¨
          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH

          # 5. éªŒè¯ç¼–è¯‘å™¨æ–‡ä»¶å­˜åœ¨æ€§ï¼ˆç›´è§‚ç¡®è®¤å·¥å…·å¯ç”¨ï¼‰
          echo -e "\n=== éªŒè¯aarch64ç¼–è¯‘å™¨æ–‡ä»¶ ==="
          COMPILER_FILE="${NDK_TOOLCHAIN_BIN}/aarch64-linux-android-clang"
          if [ -f "${COMPILER_FILE}" ] && [ -x "${COMPILER_FILE}" ]; then
            echo "âœ… ç¼–è¯‘å™¨å­˜åœ¨ä¸”å¯æ‰§è¡Œï¼š${COMPILER_FILE}"
            echo "COMPILER=${COMPILER_FILE}" >> $GITHUB_ENV  # æŒä¹…åŒ–ç¼–è¯‘å™¨è·¯å¾„
          else
            echo "Error: AArch64 compiler not found!"
            ls -la "${NDK_TOOLCHAIN_BIN}" | grep "aarch64-linux-android"
            exit 1
          fi
        continue-on-error: false

      # ç¼–è¯‘å®‰å“å†…æ ¸æ¨¡å—ï¼ˆç›´æ¥ç”¨ç»å¯¹è·¯å¾„ç¼–è¯‘å™¨ï¼Œé›¶åå·®ï¼‰
      - name: Compile AArch64 Kernel Module
        run: |
          echo "=== ç¡®è®¤Makefileå­˜åœ¨ ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }

          echo "=== å¼€å§‹äº¤å‰ç¼–è¯‘ ==="
          # ç”¨ç»å¯¹è·¯å¾„ç¼–è¯‘å™¨ï¼Œå½»åº•é¿å…PATHé…ç½®é—®é¢˜ï¼ŒåŒæ—¶æŒ‡å®šAPI31
          make -j$(nproc) V=1 \
            CC="${COMPILER}" \
            CXX="${NDK_TOOLCHAIN_BIN}/aarch64-linux-android-clang++" \
            TARGET_API=31
        continue-on-error: false

      # æŒ‰éœ€ä¿ç•™ï¼Œå†…æ ¸æ¨¡å—é¡¹ç›®é€šå¸¸æ— éœ€
      - name: Run tests (if supported)
        run: make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: make distcheck
        continue-on-error: true
