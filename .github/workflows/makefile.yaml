name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build_desc:
        description: 'ÊûÑÂª∫ÊèèËø∞ÔºàÂèØÈÄâÔºâ'
        required: false
        default: 'ÊâãÂä®Ëß¶ÂèëÂÜÖÊ†∏Ê®°ÂùóÊûÑÂª∫'
      build_env:
        description: 'ÊûÑÂª∫ÁéØÂ¢É'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - test

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          set -euo pipefail; set -x
          sudo sed -i 's@http://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@http://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing --allow-releaseinfo-change
          sudo apt-get install -y --no-install-recommends build-essential wget curl unzip findutils git
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          md5sum --version || echo "md5sumÂ∑≤ÂÜÖÁΩÆÔºåÊó†ÈúÄÂÆâË£Ö"
        continue-on-error: false

      - name: Download Android Kernel Source (aarch64, API 31)
        run: |
          set -euo pipefail; set -x
          KERNEL_VERSION="android12-5.10"
          KERNEL_DIR="/home/runner/android-kernel-source"
          KERNEL_REPO="https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/kernel/common.git"

          sudo rm -rf ${KERNEL_DIR}
          sudo mkdir -p ${KERNEL_DIR}
          sudo chmod -R 777 ${KERNEL_DIR}
          sudo chown -R runner:runner ${KERNEL_DIR}

          git clone --depth 1 --branch ${KERNEL_VERSION} ${KERNEL_REPO} ${KERNEL_DIR} || {
            echo "‚ùå Ê∏ÖÂçéÈïúÂÉèÂÖãÈöÜÂ§±Ë¥•ÔºåÂàáÊç¢ÂÆòÊñπÈïúÂÉèÈáçËØï..."
            git clone --depth 1 --branch ${KERNEL_VERSION} https://android.googlesource.com/kernel/common.git ${KERNEL_DIR} || {
              echo "‚ùå ÂÜÖÊ†∏Ê∫êÁ†Å‰∏ãËΩΩÂ§±Ë¥•ÔºåÁªàÊ≠¢ÊµÅÁ®ã"
              exit 1
            }
          }

          COMPILER_H_PATH="${KERNEL_DIR}/include/linux/compiler.h"
          if [ ! -f ${COMPILER_H_PATH} ]; then
            echo "‚ùå ÂÜÖÊ†∏Ê∫êÁ†Å‰∏≠Êú™ÊâæÂà∞compiler.hÔºåÊêúÁ¥¢ÂèØËÉΩË∑ØÂæÑ..."
            find ${KERNEL_DIR} -name "compiler.h" -type f | head -5
            exit 1
          fi
          echo "‚úÖ ÂÜÖÊ†∏Ê∫êÁ†Å‰∏ãËΩΩÂÆåÊàêÔºåcompiler.hË∑ØÂæÑÔºö${COMPILER_H_PATH}"
          echo "KERNEL_DIR=${KERNEL_DIR}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Download & Extract Android NDK (r25c, Super Fault-Tolerant)
        run: |
          set -euo pipefail; set -x
          NDK_VERSION="r25c"
          CORRECT_NDK_MD5="7845ab5be16149828ebac818a087d4ab"
          MIN_NDK_SIZE=$((450 * 1024 * 1024))
          ALIYUN_NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          GOOGLE_NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
          HUAWEI_NDK_URL="https://mirrors.huaweicloud.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          NDK_ZIP="/home/runner/ndk.zip"
          NDK_UNZIP_DIR="/home/runner/android-ndk-unzip"
          REAL_NDK_DIR=""

          echo "üîß Ê∏ÖÁêÜÊóßÊñá‰ª∂..."
          sudo rm -rf ${NDK_ZIP} ${NDK_UNZIP_DIR}
          sudo mkdir -p ${NDK_UNZIP_DIR}
          sudo chmod -R 777 ${NDK_UNZIP_DIR}
          sudo chown -R runner:runner ${NDK_UNZIP_DIR}
          ls -ld ${NDK_UNZIP_DIR}

          download_ndk() {
            local url=$1
            echo -e "\nüì• Â∞ùËØï‰ªéÊ∫ê‰∏ãËΩΩÔºö${url}"
            sudo rm -f ${NDK_ZIP}
            echo "üîπ ‰ºòÂÖà‰ΩøÁî®wget‰∏ãËΩΩ..."
            sudo wget --no-cache --no-cookies --timeout=1200 \
              --tries=10 --retry-connrefused --waitretry=30 --progress=bar:force \
              --no-check-certificate -O ${NDK_ZIP} ${url} -S 2>&1 | grep "HTTP/" || {
                echo "üîπ wget‰∏ãËΩΩÂ§±Ë¥•ÔºåÂàáÊç¢curlÈáçËØï..."
                sudo curl -fSL --connect-timeout 1200 --retry 10 --retry-delay 30 \
                  --retry-max-time 3600 --insecure -o ${NDK_ZIP} ${url} -w "HTTPÁä∂ÊÄÅÁ†ÅÔºö%{http_code}\n" || {
                  echo "‚ùå ËØ•Ê∫êÂèåÂ∑•ÂÖ∑‰∏ãËΩΩÂùáÂ§±Ë¥•"
                  return 1
                }
              }
            if [ ! -f ${NDK_ZIP} ] || [ ! -s ${NDK_ZIP} ]; then
              echo "‚ùå ‰∏ãËΩΩÊñá‰ª∂‰∏çÂ≠òÂú®/‰∏∫Á©∫"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            local zip_size=$(du -b ${NDK_ZIP} | awk '{print $1}')
            echo "üìè ÂéãÁº©ÂåÖ‰ΩìÁßØÔºö${zip_size}Â≠óËäÇÔºàÁ∫¶$(echo "scale=2; ${zip_size}/1024/1024" | bc)MBÔºâ"
            if [ ${zip_size} -lt ${MIN_NDK_SIZE} ]; then
              echo "‚ùå ‰ΩìÁßØËøáÂ∞èÔºåÂà§ÂÆöÊçüÂùè"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            local calc_md5=$(md5sum ${NDK_ZIP} | awk '{print $1}')
            if [ "${calc_md5}" != "${CORRECT_NDK_MD5}" ]; then
              echo "‚ùå MD5‰∏çÂåπÈÖçÔºàÈ¢ÑÊúüÔºö${CORRECT_NDK_MD5}ÔºåÂÆûÈôÖÔºö${calc_md5}Ôºâ"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            echo "üîç Ê†°È™åÂéãÁº©ÂåÖÂÜÖÁªìÊûÑÔºàÂâç20‰∏™Êñá‰ª∂Ôºâ..."
            local zip_file_count=$(sudo unzip -l ${NDK_ZIP} | wc -l)
            if [ ${zip_file_count} -lt 10 ]; then
              echo "‚ùå ÂéãÁº©ÂåÖÂÜÖÊó†ÊúâÊïàÂÜÖÂÆπÔºåÂà§ÂÆöÊçüÂùè"
              sudo unzip -l ${NDK_ZIP}
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            echo "‚úÖ ËØ•Ê∫ê‰∏ãËΩΩÊàêÂäüÔºåÂéãÁº©ÂåÖÂÆåÊï¥‰∏îÂÜÖÂê´ÊúâÊïàÂÜÖÂÆπ"
            return 0
          }

          if download_ndk ${ALIYUN_NDK_URL}; then
            echo -e "\nüéâ ‰ºòÂÖàÊ∫êÔºàÈòøÈáå‰∫ëÔºâ‰∏ãËΩΩÊàêÂäü"
          elif download_ndk ${HUAWEI_NDK_URL}; then
            echo -e "\nüéâ Â§áÁî®Ê∫ê1ÔºàÂçé‰∏∫ÈïúÂÉèÔºâ‰∏ãËΩΩÊàêÂäü"
          elif download_ndk ${GOOGLE_NDK_URL}; then
            echo -e "\nüéâ Â§áÁî®Ê∫ê2ÔºàË∞∑Ê≠åÂÆòÊñπÔºâ‰∏ãËΩΩÊàêÂäü"
          else
            echo -e "\n‚ùå 3Ê∫êÂèåÂ∑•ÂÖ∑‰∏ãËΩΩÂùáÂ§±Ë¥•"
            exit 1
          fi

          echo -e "\nüì¶ Ëß£ÂéãNDKÂà∞ ${NDK_UNZIP_DIR}..."
          sudo unzip -o -q ${NDK_ZIP} -d ${NDK_UNZIP_DIR} || {
            echo "‚ùå Ëß£ÂéãÂ§±Ë¥•ÔºåÊü•ÁúãÂéãÁº©ÂåÖÂÜÖÂÆπ..."
            sudo unzip -l ${NDK_ZIP} | head -30
            sudo rm -f ${NDK_ZIP}
            exit 1
          }
          echo -e "\nüìÇ Ëß£ÂéãÂêéÁõÆÊ†áÁõÆÂΩïÂÜÖÂÆπÔºàÂê´Â≠êÁõÆÂΩïÔºâÔºö"
          ls -la ${NDK_UNZIP_DIR}/
          unzip_file_count=$(find ${NDK_UNZIP_DIR} -type f | wc -l)
          if [ ${unzip_file_count} -eq 0 ]; then
            echo "‚ùå Ëß£ÂéãÂêéÁõÆÂΩï‰∏∫Á©∫ÔºåÊó†‰ªª‰ΩïÊúâÊïàÊñá‰ª∂ÔºåÂà§ÂÆöËß£ÂéãÂ§±Ë¥•"
            echo "üîç ÂéãÁº©ÂåÖÂÜÖÂÆåÊï¥Êñá‰ª∂ÂàóË°®ÔºàÂâç50‰∏™ÔºâÔºö"
            sudo unzip -l ${NDK_ZIP} | head -50
            sudo rm -f ${NDK_ZIP}
            exit 1
          fi
          echo "‚úÖ Ëß£ÂéãÊàêÂäüÔºåÂÖ±Ëß£ÂéãÂá∫ ${unzip_file_count} ‰∏™Êñá‰ª∂"

          echo -e "\nüîç Âä®ÊÄÅÊü•ÊâæÁúüÂÆûNDKÊ†πÁõÆÂΩï..."
          REAL_NDK_DIR=$(find ${NDK_UNZIP_DIR} -maxdepth 2 -type d -exec test -d "{}/toolchains/llvm/prebuilt" \; -print | head -n1)
          if [ -z "${REAL_NDK_DIR}" ] || [ ! -d "${REAL_NDK_DIR}" ]; then
            REAL_NDK_DIR=$(find ${NDK_UNZIP_DIR} -type d -exec test -d "{}/toolchains/llvm/prebuilt" \; -print | head -n1)
          fi
          if [ -z "${REAL_NDK_DIR}" ] || [ ! -d "${REAL_NDK_DIR}" ]; then
            REAL_NDK_DIR=$(ls -d ${NDK_UNZIP_DIR}/*/ 2>/dev/null | head -n1)
          fi
          if [ -z "${REAL_NDK_DIR}" ] || [ ! -d "${REAL_NDK_DIR}" ]; then
            echo "‚ùå Êú™ÊâæÂà∞ÁúüÂÆûNDKÊ†πÁõÆÂΩïÔºåÊâìÂç∞ÂÖ®ÈáèËß£ÂéãÁõÆÂΩïÁªìÊûÑÔºö"
            find ${NDK_UNZIP_DIR} -type d | head -30
            sudo rm -f ${NDK_ZIP}
            exit 1
          fi
          echo "‚úÖ ÁúüÂÆûNDKÊ†πÁõÆÂΩïÔºö${REAL_NDK_DIR}"

          sudo chmod -R 777 ${REAL_NDK_DIR}
          sudo chown -R runner:runner ${REAL_NDK_DIR}

          echo -e "\n‚úÖ Ê†°È™åÂ∑•ÂÖ∑ÈìæÁõÆÂΩï..."
          ls -la ${REAL_NDK_DIR}/toolchains/
          if [ ! -d "${REAL_NDK_DIR}/toolchains/llvm/prebuilt" ]; then
            echo "‚ùå Â∑•ÂÖ∑ÈìæÊ†∏ÂøÉÁõÆÂΩïÁº∫Â§±ÔºÅÊâìÂç∞llvmÁõÆÂΩïÂÜÖÂÆπÔºö"
            ls -la ${REAL_NDK_DIR}/toolchains/llvm/ 2>/dev/null || echo "llvmÁõÆÂΩï‰∏çÂ≠òÂú®"
            exit 1
          fi

          echo -e "\nüîç Êü•ÊâæAArch64 clangÁºñËØëÂô®..."
          LLVM_BIN_DIR=$(find ${REAL_NDK_DIR}/toolchains/llvm/prebuilt -name "bin" -type d 2>/dev/null | head -n1)
          echo "llvmÂ∑•ÂÖ∑ÈìæbinÁõÆÂΩïÔºö${LLVM_BIN_DIR}"
          
          COMPILER=$(find ${LLVM_BIN_DIR} -name "aarch64-linux-android*-clang" -type f 2>/dev/null | head -n1)
          
          if [ -z "${COMPILER}" ] || [ ! -f "${COMPILER}" ]; then
            echo "üîπ Á≤æÂáÜÊü•ÊâæÂ§±Ë¥•ÔºåÂÖ®Ë∑ØÂæÑÂÖúÂ∫ïÊêúÁ¥¢..."
            COMPILER=$(find ${REAL_NDK_DIR} -name "aarch64-linux-android*-clang" -type f 2>/dev/null | head -n1)
          fi
          
          if [ -z "${COMPILER}" ] || [ ! -f "${COMPILER}" ]; then
            echo "‚ùå Êú™ÊâæÂà∞AArch64 clangÁºñËØëÂô®ÔºÅÊâìÂç∞ÊâÄÊúâclangÁõ∏ÂÖ≥Â∑•ÂÖ∑Ôºö"
            find ${REAL_NDK_DIR} -name "*clang*" -type f 2>/dev/null | head -20
            exit 1
          fi
          
          NDK_TOOLCHAIN_BIN=$(dirname ${COMPILER})
          echo "‚úÖ ÊâæÂà∞AArch64ÁºñËØëÂô®Ôºö${COMPILER}"
          echo "‚úÖ Â∑•ÂÖ∑Èìæ‰∫åËøõÂà∂ÁõÆÂΩïÔºö${NDK_TOOLCHAIN_BIN}"

          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_HOME=${REAL_NDK_DIR}" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH
          echo "‚úÖ NDKÈÖçÁΩÆÂÆåÊàêÔºåÂ∑•ÂÖ∑ÈìæË∑ØÂæÑÔºö${NDK_TOOLCHAIN_BIN}"
        continue-on-error: false

      - name: Verify AArch64 Compiler (Full Check)
        run: |
          set -euo pipefail; set -x
          echo "=== Á°ÆËÆ§ÁéØÂ¢ÉÂèòÈáè ==="
          if [ -z "${NDK_HOME}" ] || [ -z "${NDK_TOOLCHAIN_BIN}" ]; then
            echo "Error: NDK_HOME/NDK_TOOLCHAIN_BINÁº∫Â§±ÔºÅ"
            echo "ÂΩìÂâçÁéØÂ¢ÉÂèòÈáèÔºö$(env | grep NDK)"
            exit 1
          fi
          echo "NDK_HOME: ${NDK_HOME}"
          echo "NDK_TOOLCHAIN_BIN: ${NDK_TOOLCHAIN_BIN}"

          echo "=== Á°ÆËÆ§ÁºñËØëÂô® ==="
          if [ -z "${COMPILER:-}" ] || [ ! -f "${COMPILER:-}" ]; then
            echo "üîπ ÁºñËØëÂô®ÂèòÈáèÊú™ÂÆö‰πâ/Êó†ÊïàÔºåÂÖúÂ∫ïÊêúÁ¥¢..."
            COMPILER=$(find ${NDK_HOME} -name "aarch64-linux-android*-clang" -type f 2>/dev/null | head -n1)
            if [ -z "${COMPILER}" ]; then
              echo "Error: ÁºñËØëÂô®Áº∫Â§±ÔºÅ"
              exit 1
            fi
          fi
          echo "ÊâæÂà∞ÁºñËØëÂô®Ôºö${COMPILER}"

          echo "=== Ê†°È™åÁºñËØëÂô®ÂÆåÊï¥ÊÄß ==="
          if [ ! -x "${COMPILER}" ]; then
            echo "ÁºñËØëÂô®Êó†ÊâßË°åÊùÉÈôêÔºåËµãÊùÉ..."
            sudo chmod 777 ${COMPILER}
            if [ ! -x "${COMPILER}" ]; then
              echo "Error: ËµãÊùÉÂêé‰ªçÊó†ÊâßË°åÊùÉÈôêÔºåÊñá‰ª∂‰ø°ÊÅØÔºö"
              file ${COMPILER}
              exit 1
            fi
          fi
          ${COMPILER} --version >/dev/null 2>&1 || {
            echo "Error: ÁºñËØëÂô®ËÑöÊú¨ÊâßË°åÂ§±Ë¥•ÔºÅÊñá‰ª∂‰ø°ÊÅØÔºö"
            file ${COMPILER}
            exit 1
          }

          echo "=== È™åËØÅÁºñËØëÂô®ÁâàÊú¨ ==="
          ${COMPILER} --version || {
            echo "Error: ÁºñËØëÂô®ÊâßË°åÂ§±Ë¥•ÔºÅ"
            echo "ÁºñËØëÂô®ËÑöÊú¨Ê†∏ÂøÉÂÜÖÂÆπÔºàÂâç10Ë°åÔºâÔºö"
            head -n 10 ${COMPILER}
            exit 1
          }
          echo "‚úÖ ÁºñËØëÂô®È™åËØÅÈÄöËøá"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Compile AArch64 Kernel Module
        run: |
          set -euo pipefail; set -x
          echo "=== Á°ÆËÆ§Makefile ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }
          echo "=== MakefileÊ†∏ÂøÉÂÜÖÂÆπÔºàÂâç50Ë°åÔºâ ==="
          head -n 50 Makefile 2>/dev/null

          # Ê†∏ÂøÉ‰øÆÂ§çÔºö‰øÆÊ≠£ÂèÇÊï∞Ê†ºÂºèÔºàÊØèË°å1‰∏™ÂèÇÊï∞ÔºåÂèçÊñúÊù†ÂêéÊó†Â§ö‰ΩôÂ≠óÁ¨¶ÔºåÂèÇÊï∞ËµãÂÄºÊó†ËØ≠Ê≥ïÈîôËØØÔºâ
          echo "=== ÂºÄÂßã‰∫§ÂèâÁºñËØë ==="
          make -j$(nproc) V=2 \
            CC="${COMPILER}" \
            CXX=$(find ${NDK_HOME} -name "aarch64-linux-android*-clang++" -type f 2>/dev/null | head -n1) \
            TARGET_ARCH=aarch64 \
            TARGET_API=31 \
            NDK="${NDK_HOME}" \
            CROSS_COMPILE=aarch64-linux-android- \
            KERNELDIR="${KERNEL_DIR}" \
            ARCH=arm64 \
            CFLAGS="-I${KERNEL_DIR}/include -I${KERNEL_DIR}/include/linux" || {
            echo "Error: ÁºñËØëÂ§±Ë¥•ÔºÅ"
            exit 1
          }
        continue-on-error: false

      - name: Run tests (if supported)
        run: |
          set -euo pipefail; set -x
          make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: |
          set -euo pipefail; set -x
          make distcheck
        continue-on-error: true
