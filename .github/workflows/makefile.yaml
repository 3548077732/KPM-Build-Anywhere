name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      # 1. 拉取代码（全量拉取，确保Makefile不缺失）
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          show-progress: true
        continue-on-error: false

      # 2. 安装核心编译依赖（移除autoconf等无用工具，精简高效）
      - name: Install build dependencies
        run: |
          sudo sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list
          sudo sed -i s@/security.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list
          sudo apt-get update -y --fix-missing
          sudo apt-get install -f -y
          # 仅保留原生Makefile项目必备编译工具，无冗余
          sudo apt-get install -y --no-install-recommends \
            build-essential \  # 核心gcc、make工具链
            libc6-dev  # 基础C库头文件，避免编译缺头文件
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          # 校验编译工具可用性
          gcc --version || exit 1
          make --version || exit 1
        continue-on-error: false

      # 3. 编译项目（直接执行make，前置校验Makefile存在性）
      - name: Compile project
        run: |
          echo "=== 校验Makefile是否存在 ==="
          ls -la | grep -E "Makefile|makefile"  # 忽略大小写匹配
          if [ ! -f ./Makefile ] && [ ! -f ./makefile ]; then
            echo "Fatal: Makefile not found in project root!"
            exit 1
          fi
          echo "=== 开始多线程编译 ==="
          make -j$(nproc) V=1  # 多线程加速+详细日志
        continue-on-error: false

      # 4. 执行测试（原生Makefile项目通用check命令）
      - name: Run unit tests (make check)
        run: make check
        continue-on-error: false

      # 5. 发布包校验（若项目不支持distcheck，后续可注释此步骤）
      - name: Verify release package (make distcheck)
        run: make distcheck
        continue-on-error: true  # 部分原生Makefile无此命令，暂设允许失败
