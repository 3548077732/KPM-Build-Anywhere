name: Makefile CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04  # 固化稳定系统，减少包兼容问题
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 核心修复：依赖安装步骤（解决找不到包裹问题）
      - name: Install build dependencies
        run: |
          # 1. 强制更新apt源缓存（关键，避免旧缓存找不到包）
          sudo apt-get update -y --fix-missing --allow-releaseinfo-change
          # 2. 修复依赖冲突，清理无效包（容错）
          sudo apt-get install -f -y
          # 3. 安装核心依赖（修正语法：反斜杠后无空格，包名精简适配ubuntu22.04）
          sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          libtool \
          texinfo \
          pkg-config \
          # 可选：若项目依赖其他库，补充正确包名（例：openssl依赖 libssl-dev）
          --no-install-recommends  # 减少冗余依赖，加速安装
          # 4. 排查输出：打印已安装核心工具版本，方便定位问题
          gcc --version
          make --version
          autoconf --version

      - name: Autoconf generate Makefile
        run: ./configure
        continue-on-error: false

      - name: Compile project
        run: make -j$(nproc)  # 多线程加速，适配runner核心数

      - name: Run unit tests (make check)
        run: make check

      - name: Verify release package (make distcheck)
        run: make distcheck

      # 执行 Autoconf 配置（生成 Makefile）
      - name: Autoconf generate Makefile
        run: ./configure
        # 配置失败立即终止，减少无效执行
        continue-on-error: false

      # 编译项目（原 "Install dependencies" 命名错误，修正为编译逻辑）
      - name: Compile project
        run: make -j$(nproc)  # 多线程编译，提升 CI 效率（适配 runner 核心数）

      # 执行单元测试/功能校验
      - name: Run unit tests (make check)
        run: make check

      # 执行发布包完整性校验（Autoconf 项目标准发布前校验步骤）
      - name: Verify release package (make distcheck)
        run: make distcheck
