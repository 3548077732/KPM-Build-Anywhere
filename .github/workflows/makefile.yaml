name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing
          sudo apt-get install -y --no-install-recommends build-essential wget unzip findutils
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
        continue-on-error: false

      # å…³é”®ä¼˜åŒ–ï¼šæ¢ç¨³å®šNDK r25cï¼ˆå…¼å®¹æ€§æ‹‰æ»¡ï¼Œå·¥å…·é“¾æ— ç¼ºå¤±ï¼‰+ åŠ¨æ€é€‚é…è·¯å¾„
      - name: Download & Extract Android NDK (r25c)
        run: |
          NDK_VERSION="r25c"
          # ä¼˜å…ˆé˜¿é‡Œäº‘é•œåƒï¼ˆä¸‹è½½å¿«+ä¸æ˜“æŸåï¼Œé¿å…è°·æ­Œæºæ–‡ä»¶æ®‹ç¼ºï¼‰
          NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux.zip"
          NDK_INSTALL_DIR="/opt/android-ndk-${NDK_VERSION}"

          # 1. ç¨³å®šä¸‹è½½ï¼ˆå»¶é•¿è¶…æ—¶+å¤šæ¬¡é‡è¯•+è¿›åº¦æç¤ºï¼Œé¿å…æ–‡ä»¶æŸåï¼‰
          echo "ğŸ“¥ ä¸‹è½½NDK ${NDK_VERSION}..."
          wget -P ./ --timeout=600 --tries=5 --show-progress -O ndk.zip "${NDK_URL}" || {
            echo "å¤‡ç”¨æºé‡è¯•..."
            NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
            wget -P ./ --timeout=600 --tries=5 --show-progress -O ndk.zip "${NDK_URL}" || exit 1
          }

          # 2. è§£å‹ï¼ˆåŠ verboseï¼Œç¡®è®¤è§£å‹è¿‡ç¨‹æ— æŠ¥é”™ï¼‰
          echo "ğŸ“¦ è§£å‹NDKåˆ° ${NDK_INSTALL_DIR}..."
          unzip -q -v ndk.zip -d /opt/ || {
            echo "NDKè§£å‹å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸåï¼"
            rm -f ndk.zip
            exit 1
          }
          if [ ! -d "${NDK_INSTALL_DIR}" ]; then
            echo "è§£å‹ç›®å½•ä¸å­˜åœ¨ï¼Œæ‰“å°/optç›®å½•ç»“æ„ï¼š"
            ls -la /opt/
            exit 1
          fi

          # 3. åŠ¨æ€è·å–å·¥å…·é“¾ç³»ç»Ÿç›®å½•ï¼ˆä¸ç¡¬ç¼–ç ï¼Œé€‚é…æ‰€æœ‰x86_64 Runnerï¼‰
          echo -e "\nğŸ” è‡ªåŠ¨è¯†åˆ«NDKå·¥å…·é“¾ç³»ç»Ÿç›®å½•..."
          PREBUILT_DIR="${NDK_INSTALL_DIR}/toolchains/llvm/prebuilt"
          # ç­›é€‰linux-x86_64ç›¸å…³ç›®å½•ï¼ˆRunneræ˜¯x86_64æ¶æ„ï¼Œç²¾å‡†åŒ¹é…ï¼‰
          SYSTEM_DIR=$(ls -d ${PREBUILT_DIR}/linux-* 2>/dev/null | head -n1)
          if [ -z "${SYSTEM_DIR}" ]; then
            echo "å·¥å…·é“¾ç³»ç»Ÿç›®å½•æœªæ‰¾åˆ°ï¼Œæ‰“å°prebuiltç›®å½•ï¼š"
            ls -la ${PREBUILT_DIR}/
            exit 1
          fi
          NDK_TOOLCHAIN_BIN="${SYSTEM_DIR}/bin"
          echo "âœ… è‡ªåŠ¨åŒ¹é…å·¥å…·é“¾è·¯å¾„ï¼š${NDK_TOOLCHAIN_BIN}"

          # 4. é…ç½®ç¯å¢ƒ+å¼ºåˆ¶èµ‹æ‰§è¡Œæƒé™ï¼ˆæ ¸å¿ƒè§£å†³ä¸å¯æ‰§è¡Œé—®é¢˜ï¼‰
          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_HOME=${NDK_INSTALL_DIR}" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH
          # ç»™æ‰€æœ‰clangç¼–è¯‘å™¨åŠ æ‰§è¡Œæƒé™ï¼Œé¿å…æƒé™ä¸è¶³
          sudo chmod +x ${NDK_TOOLCHAIN_BIN}/*clang* 2>/dev/null
          echo "âœ… NDKé…ç½®+æƒé™èµ‹äºˆå®Œæˆ"
        continue-on-error: false

      # ç²¾å‡†æ ¡éªŒï¼šå…¨å±€æœç´¢ç¼–è¯‘å™¨+ç¡®è®¤å¯ç”¨æ€§
      - name: Verify AArch64 Compiler
        run: |
          echo "=== å…¨å±€æœç´¢aarch64ç¼–è¯‘å™¨ï¼ˆç¡®ä¿æ–‡ä»¶å­˜åœ¨ï¼‰ ==="
          # å…¨å±€æŸ¥æ‰¾ç¼–è¯‘å™¨ï¼Œæ’é™¤è·¯å¾„åå·®
          COMPILER=$(find ${NDK_HOME} -name "aarch64-linux-android-clang" -type f | head -n1)
          if [ -z "${COMPILER}" ]; then
            echo "Error: å…¨å±€æœªæ‰¾åˆ°aarch64ç¼–è¯‘å™¨ï¼æ‰“å°NDKå·¥å…·é“¾ç›®å½•æ–‡ä»¶ï¼š"
            ls -la ${NDK_TOOLCHAIN_BIN}/ | grep "clang"
            exit 1
          fi
          echo "âœ… å…¨å±€æ‰¾åˆ°ç¼–è¯‘å™¨ï¼š${COMPILER}"

          # ç¡®è®¤ç¼–è¯‘å™¨å¯æ‰§è¡Œ
          if [ ! -x "${COMPILER}" ]; then
            echo "ç¼–è¯‘å™¨æ— æ‰§è¡Œæƒé™ï¼Œé‡æ–°èµ‹æƒ..."
            sudo chmod +x "${COMPILER}"
            if [ ! -x "${COMPILER}" ]; then
              echo "Error: ç¼–è¯‘å™¨èµ‹æƒå¤±è´¥ï¼"
              exit 1
            fi
          fi

          # æœ€ç»ˆéªŒè¯ç‰ˆæœ¬ï¼Œç¡®è®¤å·¥å…·å¯ç”¨
          echo -e "\n=== ç¼–è¯‘å™¨ç‰ˆæœ¬ä¿¡æ¯ ==="
          ${COMPILER} --version || {
            echo "Error: ç¼–è¯‘å™¨æ‰§è¡Œå¤±è´¥ï¼"
            file "${COMPILER}"  # æŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼Œæ’æŸ¥æ˜¯å¦æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶
            exit 1
          }
          echo "âœ… ç¼–è¯‘å™¨éªŒè¯å®Œå…¨é€šè¿‡"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Compile AArch64 Kernel Module
        run: |
          echo "=== ç¡®è®¤Makefileå­˜åœ¨ ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }

          echo "=== å¼€å§‹äº¤å‰ç¼–è¯‘ ==="
          make -j$(nproc) V=1 \
            CC="${COMPILER}" \
            CXX=$(find ${NDK_HOME} -name "aarch64-linux-android-clang++" -type f | head -n1) \
            TARGET_API=31
        continue-on-error: false

      - name: Run tests (if supported)
        run: make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: make distcheck
        continue-on-error: true
