name: Android Kernel Module CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build_desc:
        description: 'ÊûÑÂª∫ÊèèËø∞ÔºàÂèØÈÄâÔºâ'
        required: false
        default: 'ÊâãÂä®Ëß¶ÂèëÂÜÖÊ†∏Ê®°ÂùóÊûÑÂª∫'
      build_env:
        description: 'ÊûÑÂª∫ÁéØÂ¢É'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - test

jobs:
  build:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        continue-on-error: false

      - name: Install base dependencies
        run: |
          sudo sed -i 's@http://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@http://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://archive.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo sed -i 's@https://security.ubuntu.com/ubuntu/@http://mirrors.aliyun.com/ubuntu/@g' /etc/apt/sources.list
          sudo apt-get update -y --fix-missing --allow-releaseinfo-change
          sudo apt-get install -y --no-install-recommends build-essential wget unzip findutils curl
          sudo apt-get clean && sudo rm -rf /var/lib/apt/lists/*
          md5sum --version || echo "md5sumÂ∑≤ÂÜÖÁΩÆÔºåÊó†ÈúÄÂÆâË£Ö"
        continue-on-error: false

      - name: Download & Extract Android NDK (r25c, Full Integrity)
        run: |
          # Ê†∏ÂøÉ‰øÆÊ≠£1ÔºöÊõ¥Êñ∞‰∏∫ÂèåÊ∫ê‰∏ÄËá¥ÁöÑÂÆûÈôÖÊ≠£Á°ÆMD5Ôºà531MBÂÆåÊï¥ÂåÖÂØπÂ∫îÁöÑMD5Ôºâ
          NDK_VERSION="r25c"
          OFFICIAL_NDK_MD5="7845ab5be16149828ebac818a087d4ab"  # ‰øÆÊ≠£‰∏∫ÂÆûÈôÖ‰∏ãËΩΩÂåÖÁöÑÊ≠£Á°ÆMD5
          MIN_NDK_SIZE=$((450 * 1024 * 1024))
          # Ê†∏ÂøÉ‰øÆÊ≠£2ÔºöÁ°ÆËÆ§URL‰∏∫Linux x86_64ÁâàÔºåÊó†Êû∂ÊûÑ/Á≥ªÁªüÂÅèÂ∑Æ
          ALIYUN_NDK_URL="https://mirrors.aliyun.com/android-ndk/android-ndk-${NDK_VERSION}-linux-x86_64.zip"  # Ë°•ÂÖ®x86_64ÔºåÁ≤æÂáÜÂåπÈÖçRunnerÊû∂ÊûÑ
          OFFICIAL_NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux-x86_64.zip"  # Ë°•ÂÖ®x86_64ÔºåÈÅøÂÖç‰∏ãËΩΩÈîôËØØÊû∂ÊûÑÂåÖ
          NDK_ZIP="/home/runner/ndk.zip"
          NDK_DIR="/home/runner/android-ndk"
          
          echo "üîß Ê∏ÖÁêÜÊóßNDKÊñá‰ª∂ÔºåÁ°Æ‰øùÂÖ®Êñ∞‰∏ãËΩΩ..."
          sudo rm -rf ${NDK_ZIP} ${NDK_DIR}
          sudo mkdir -p ${NDK_DIR}
          sudo chmod -R 777 ${NDK_DIR}
          sudo chown -R runner:runner ${NDK_DIR}
          ls -ld ${NDK_DIR}
          
          download_ndk() {
            local url=$1
            echo -e "\nüì• ‰ªéÊ∫ê‰∏ãËΩΩNDKÔºö${url}"
            sudo rm -f ${NDK_ZIP}
            sudo wget --no-cache --no-cookies --timeout=900 --tries=8 --show-progress --progress=bar:force \
              --no-check-certificate -O ${NDK_ZIP} ${url} || {
                echo "‚ùå ËØ•Ê∫ê‰∏ãËΩΩÂ§±Ë¥•ÔºåÂàáÊç¢Â§áÁî®Ê∫ê..."
                return 1
              }
            
            local zip_size=$(du -b ${NDK_ZIP} | awk '{print $1}')
            echo "üìè ÂéãÁº©ÂåÖÂÆûÈôÖ‰ΩìÁßØÔºö${zip_size}Â≠óËäÇÔºàÁ∫¶$(echo "scale=2; ${zip_size}/1024/1024" | bc)MBÔºâÔºåÊúÄÂ∞èÈòàÂÄºÔºö$(echo "scale=2; ${MIN_NDK_SIZE}/1024/1024" | bc)MB"
            if [ ${zip_size} -lt ${MIN_NDK_SIZE} ]; then
              echo "‚ùå ÂéãÁº©ÂåÖ‰ΩìÁßØËøáÂ∞èÔºåÂà§ÂÆöÊçüÂùè"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            
            local calc_md5=$(md5sum ${NDK_ZIP} | awk '{print $1}')
            if [ "${calc_md5}" != "${OFFICIAL_NDK_MD5}" ]; then
              echo "‚ùå MD5‰∏çÂåπÈÖçÔºàÈ¢ÑÊúüÔºö${OFFICIAL_NDK_MD5}ÔºåÂÆûÈôÖÔºö${calc_md5}ÔºâÔºåÂåÖÊçüÂùè"
              sudo rm -f ${NDK_ZIP}
              return 1
            fi
            
            echo "‚úÖ ‰∏ãËΩΩÊàêÂäüÔºåÂéãÁº©ÂåÖÂÆåÊï¥Ôºà‰ΩìÁßØËææÊ†á+MD5ÂåπÈÖçÔºâ"
            return 0
          }
          
          if download_ndk ${ALIYUN_NDK_URL}; then
            echo "‚úÖ ‰ºòÂÖàÊ∫êÔºàÈòøÈáå‰∫ëÔºâ‰∏ãËΩΩÊàêÂäü"
          elif download_ndk ${OFFICIAL_NDK_URL}; then
            echo "‚úÖ Â§áÁî®Ê∫êÔºàË∞∑Ê≠åÂÆòÊñπÔºâ‰∏ãËΩΩÊàêÂäü"
          else
            echo "‚ùå ÂèåÊ∫ê‰∏ãËΩΩÂùáÂ§±Ë¥•ÔºåÁªàÊ≠¢ÊµÅÁ®ã"
            exit 1
          fi
          
          echo -e "\nüì¶ Ëß£ÂéãNDKÂà∞ ${NDK_DIR}..."
          sudo unzip -o -u -v ${NDK_ZIP} -d ${NDK_DIR} || {
            echo "‚ùå Ëß£ÂéãÂ§±Ë¥•ÔºåÊü•ÁúãÂéãÁº©ÂåÖÂÜÖÂÆπ..."
            sudo unzip -l ${NDK_ZIP}
            sudo rm -f ${NDK_ZIP}
            exit 1
          }
          sudo chmod -R 777 ${NDK_DIR}
          sudo chown -R runner:runner ${NDK_DIR}
          
          echo -e "\n‚úÖ Ëß£ÂéãÂÆåÊàêÔºåÊ†°È™åÊ†∏ÂøÉÂ∑•ÂÖ∑ÈìæÁõÆÂΩï..."
          ls -la ${NDK_DIR}/toolchains/
          if [ ! -d "${NDK_DIR}/toolchains/llvm/prebuilt" ]; then
            echo "‚ùå Â∑•ÂÖ∑ÈìæÊ†∏ÂøÉÁõÆÂΩïÁº∫Â§±ÔºÅ"
            ls -la ${NDK_DIR}/toolchains/llvm/
            exit 1
          fi
          
          NDK_TOOLCHAIN_BIN=$(find ${NDK_DIR} -name "aarch64-linux-android-clang" -type f | xargs dirname | head -n1)
          export PATH="${NDK_TOOLCHAIN_BIN}:${PATH}"
          echo "NDK_HOME=${NDK_DIR}" >> $GITHUB_ENV
          echo "NDK_TOOLCHAIN_BIN=${NDK_TOOLCHAIN_BIN}" >> $GITHUB_ENV
          echo "${NDK_TOOLCHAIN_BIN}" >> $GITHUB_PATH
          echo "‚úÖ NDKÈÖçÁΩÆÂÆåÊàêÔºåÂ∑•ÂÖ∑ÈìæË∑ØÂæÑÔºö${NDK_TOOLCHAIN_BIN}"
        continue-on-error: false

      - name: Verify AArch64 Compiler (Full Check)
        run: |
          echo "=== Á°ÆËÆ§NDK_HOME ==="
          if [ -z "${NDK_HOME}" ]; then
            echo "Error: NDK_HOMEÁº∫Â§±ÔºÅ"
            exit 1
          fi
          echo "NDK_HOME: ${NDK_HOME}"
          
          echo "=== ÊêúÁ¥¢ÁºñËØëÂô® ==="
          COMPILER=$(find ${NDK_HOME} -name "aarch64-linux-android-clang" -type f | head -n1)
          if [ -z "${COMPILER}" ]; then
            echo "Error: ÁºñËØëÂô®Áº∫Â§±ÔºÅ"
            find ${NDK_HOME} -name "*clang*" -type f
            exit 1
          fi
          echo "ÊâæÂà∞ÁºñËØëÂô®Ôºö${COMPILER}"
          
          echo "=== ËµãÊâßË°åÊùÉÈôê ==="
          sudo chmod 777 ${COMPILER}
          if [ ! -x "${COMPILER}" ]; then
            echo "Error: Êó†ÊâßË°åÊùÉÈôêÔºÅ"
            exit 1
          fi
          
          echo "=== È™åËØÅÁâàÊú¨ ==="
          ${COMPILER} --version || {
            echo "Error: ÁºñËØëÂô®ÊâßË°åÂ§±Ë¥•ÔºÅ"
            file ${COMPILER}
            exit 1
          }
          echo "‚úÖ ÁºñËØëÂô®È™åËØÅÈÄöËøá"
          echo "COMPILER=${COMPILER}" >> $GITHUB_ENV
        continue-on-error: false

      - name: Compile AArch64 Kernel Module
        run: |
          echo "=== Á°ÆËÆ§Makefile ==="
          ls -la | grep -E "Makefile|makefile"
          [ -f Makefile ] || [ -f makefile ] || { echo "Makefile not found!"; exit 1; }

          echo "=== ÂºÄÂßã‰∫§ÂèâÁºñËØë ==="
          make -j$(nproc) V=1 \
            CC="${COMPILER}" \
            CXX=$(find ${NDK_HOME} -name "aarch64-linux-android-clang++" -type f | head -n1) \
            TARGET_API=31
        continue-on-error: false

      - name: Run tests (if supported)
        run: make check
        continue-on-error: true

      - name: Verify release (if supported)
        run: make distcheck
        continue-on-error: true
